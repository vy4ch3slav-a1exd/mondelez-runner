<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Mondelez Runner ‚Äî ULTRA</title>
<meta name="theme-color" content="#0b0b12">
<style>
  :root { --bg:#0b0b12; --card:#ffffff; --accent:#7a4bd4; --accent2:#2b7bd4; --mint:#00ff95; }
  * { box-sizing: border-box; }
  html, body { margin:0; height:100%; background:var(--bg); overflow:hidden; }
  canvas { display:block; width:100vw; height:100vh; touch-action: manipulation; }
  #ui { position:fixed; inset:0; pointer-events:none; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; }
  .hud { position:absolute; left:10px; top:8px; color:#fff; text-shadow:0 2px 10px rgba(0,0,0,.6); font-weight:800; }
  .hud .line { font-size:12px; opacity:.95; letter-spacing:.2px; }
  .hud .big { font-size:16px; margin-bottom:2px; }
  .btns { position:absolute; right:10px; top:8px; display:flex; gap:8px; }
  .btn { pointer-events:auto; border:none; border-radius:10px; padding:9px 14px; background:#2b225a; color:#fff; font-weight:800; cursor:pointer; box-shadow:0 8px 26px rgba(0,0,0,.25); }
  .btn.sec { background:var(--accent2); }
  .toast { position:absolute; left:50%; transform:translateX(-50%); bottom:9vh; background:rgba(20,20,35,.9);
           color:#d9d9ff; padding:10px 14px; border:1px solid rgba(122,75,212,.6); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.4); opacity:0; transition:opacity .25s, transform .25s; pointer-events:none; white-space:nowrap; }
  .toast.show { opacity:1; transform:translate(-50%, -8px); }
  .banner { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
  .card { pointer-events:auto; max-width:min(780px, 94vw); background:rgba(255,255,255,.97); border:3px solid var(--accent); border-radius:18px; padding:18px 20px; color:#2b225a; text-align:center; box-shadow:0 18px 60px rgba(0,0,0,.35); }
  .hidden { display:none; }
  .credits { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; color:var(--mint); font-family: ui-monospace, Menlo, Consolas, "SF Mono", monospace; text-shadow:0 0 10px rgba(0,255,149,.35); white-space:pre; }
  .devnames { font-family: ui-monospace, Menlo, Consolas, monospace; color:var(--mint); text-shadow:0 0 8px rgba(0,255,149,.35); font-size:clamp(13px,2.2vw,18px); margin:6px 0 12px; }
  .start-title { font-size: clamp(22px, 4vw, 36px); margin: 6px 0 8px; }
  .mini { opacity:.8; font-size:clamp(12px,2vw,14px); }
  .start-actions { display:flex; justify-content:center; gap:10px; margin-top:12px; }
  .avatar { width:min(160px, 32vw); margin:8px auto 6px; }
  .countdown { position:absolute; left:50%; top:38%; transform:translate(-50%,-50%); color:#fff; font-weight:900; font-size:12vh; text-shadow:0 10px 50px rgba(0,0,0,.35); pointer-events:none; }
  .debug { position:absolute; left:50%; top:6px; transform:translateX(-50%); color:#8ef; background:rgba(0,0,0,.4); padding:4px 8px; border-radius:8px; font:11px/1.2 ui-monospace, Menlo, Consolas, monospace; display:none; }
  .debug.show { display:block; }
</style>
</head>
<body>
<canvas id="game" aria-label="Mondelez Runner"></canvas>

<!-- START BANNER -->
<div class="banner" id="startBanner" aria-modal="true" role="dialog">
  <div class="card">
    <svg class="avatar" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg" aria-label="Hacker FMCG CEOs">
      <defs><linearGradient id="g1" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#0f1a2a"/><stop offset="1" stop-color="#1b2a40"/></linearGradient></defs>
      <rect x="0" y="0" width="200" height="120" rx="12" fill="url(#g1)"/>
      <!-- left visor -->
      <circle cx="70" cy="60" r="28" fill="#111827" stroke="#00ffbf" stroke-width="2"/>
      <rect x="55" y="52" width="30" height="8" rx="3" fill="#00ffbf"/>
      <!-- right visor -->
      <circle cx="130" cy="60" r="28" fill="#111827" stroke="#7a4bd4" stroke-width="2"/>
      <rect x="115" y="52" width="30" height="8" rx="3" fill="#7a4bd4"/>
      <!-- oreo chip -->
      <circle cx="100" cy="25" r="10" fill="#3b2f2f"/><circle cx="100" cy="25" r="6.5" fill="#fff"/>
    </svg>
    <div class="mini">FMCG Hackers</div>
    <h1 class="start-title">Mondelez Runner</h1>
    <div class="devnames">Œõl—î–∫—ÅŒ±ndr R√∏d—ñonœÉv  ‚Ä¢  Œõl—îx—îy Bl—ñnœÉv</div>
    <div class="mini">–°–æ–±–∏—Ä–∞–π –∫—Ä–æ—à–∫–∏, –∏–∑–±–µ–≥–∞–π OOS –∏ ¬´ERP —É–ø–∞–ª¬ª. –î–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫: –≤—Ç–æ—Ä–æ–π —Ç–∞–ø ‚Äî –≤ –≤–æ–∑–¥—É—Ö–µ.</div>
    <div class="start-actions"><button class="btn" id="startBtn" aria-label="Start the game">START</button></div>
  </div>
</div>

<div id="ui">
  <div class="hud">
    <div class="line big" id="levelLabel">–£—Ä–æ–≤–µ–Ω—å: ‚Äî</div>
    <div class="line" id="scoreLabel">–û—á–∫–∏ (–∫—Ä–æ—à–∫–∏): 0</div>
    <div class="line" id="bestLabel">–†–µ–∫–æ—Ä–¥: 0</div>
    <div class="line" id="statusLabel"></div>
  </div>
  <div class="btns">
    <button class="btn" id="restartBtn">–ó–∞–Ω–æ–≤–æ</button>
    <button class="btn sec" id="pauseBtn">–ü–∞—É–∑–∞</button>
  </div>
  <div class="toast" id="toast">–¢–µ–∫—Å—Ç</div>
  <div class="countdown hidden" id="count">3</div>
  <div class="banner hidden" id="pauseBanner"><div class="card"><h1>–ü–∞—É–∑–∞</h1><p>–¢–∞–ø–Ω–∏ –∏–ª–∏ <b>P</b> ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.</p></div></div>
  <div class="banner hidden" id="gameOverBanner"><div class="card"><h1>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</h1><p id="overMsg">–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ ‚Äî –∫—Ä–æ—à–∫–∏ —Å–∞–º–∏ —Å–µ–±—è –Ω–µ —Å–æ–±–µ—Ä—É—Ç üòè</p></div></div>
  <div class="banner hidden" id="victoryBanner"><div class="card"><h1>–ì–æ–¥ –∑–∞–∫—Ä—ã—Ç –Ω–∞ 120% KPI üéâ</h1><p>–°–µ—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–ª–∞ –≤—ã–∫–ª–∞–¥–∫—É, –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –≤ —Å—Ç—Ä–æ—é, ERP –Ω–µ –ø–∞–¥–∞–µ—Ç ‚Äî –º–æ–∂–Ω–æ –∂–∏—Ç—å!</p><div class="credits" id="credits"></div></div></div>
  <div class="debug" id="debug"></div>
</div>

<script>
(function(){
  'use strict';

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
  const ui = {
    start: document.getElementById('startBanner'),
    startBtn: document.getElementById('startBtn'),
    pause: document.getElementById('pauseBanner'),
    over: document.getElementById('gameOverBanner'),
    victory: document.getElementById('victoryBanner'),
    level: document.getElementById('levelLabel'),
    score: document.getElementById('scoreLabel'),
    best: document.getElementById('bestLabel'),
    status: document.getElementById('statusLabel'),
    toast: document.getElementById('toast'),
    restartBtn: document.getElementById('restartBtn'),
    pauseBtn: document.getElementById('pauseBtn'),
    credits: document.getElementById('credits'),
    count: document.getElementById('count'),
    debug: document.getElementById('debug')
  };

  // HiDPI scaling for iOS Safari/Chrome + desktop
  let DPR = 1, W = 0, H = 0;
  function fitCanvas(){
    const cssW = Math.max(320, window.innerWidth || document.documentElement.clientWidth);
    const cssH = Math.max(320, window.innerHeight || document.documentElement.clientHeight);
    DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    canvas.style.width = cssW + 'px';
    canvas.style.height = cssH + 'px';
    canvas.width = Math.floor(cssW * DPR);
    canvas.height = Math.floor(cssH * DPR);
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0); // important
    W = cssW; H = cssH;
  }
  window.addEventListener('resize', fitCanvas);
  window.addEventListener('orientationchange', ()=>setTimeout(fitCanvas, 120));
  fitCanvas();

  // Theme
  const PURPLE='#7a4bd4', BLUE='#2b7bd4';
  const SKY=['#0f1220','#0f1424','#111527'];
  const THEME=['#d8c6ff','#cfe6ff','#ffe9c6'];

  // State
  let state='start';
  let levelIndex=0;
  const SPEED_UP = 1.04; // +4%
  const levels=[
    { name:'–°–∫–ª–∞–¥ –†–¶', seconds:26, speedBase:4.8*SPEED_UP, spawn:{cube:0.52, fall:0.30, wall:0.18}, bonus:{discount:0.50, prepack:0.30, erid:0.20} },
    { name:'–ú–∞–≥–∞–∑–∏–Ω', seconds:30, speedBase:5.2*SPEED_UP, spawn:{cube:0.50, fall:0.32, wall:0.18}, bonus:{discount:0.48, prepack:0.34, erid:0.18} },
    { name:'–ü–µ—Ä–µ–≥–æ–≤–æ—Ä–∫–∞', seconds:34, speedBase:5.6*SPEED_UP, spawn:{cube:0.48, fall:0.34, wall:0.18}, bonus:{discount:0.46, prepack:0.34, erid:0.20} }
  ];
  let timeLeft=levels[0].seconds, t=0, last=0, speed=levels[0].speedBase;
  let score=0, best=+localStorage.getItem('mdz_best_crumbs')||0;

  // Entities
  const player={x:0,y:0,r:24,vy:0,onGround:true,shield:0,boost:0,jumps:0,maxJumps:2};
  const obstacles=[], goodies=[], crumbs=[], particles=[], confetti=[];

  // Debug helper
  let debugOn = (new URLSearchParams(location.search).get('debug')==='1');
  function dbg(msg){ if(!debugOn) return; ui.debug.textContent = msg; ui.debug.classList.add('show'); }

  function resetAll(){ levelIndex=0; setupLevel(0); score=0; t=0; state='countdown'; startCountdown(); }
  function setupLevel(i){
    const L=levels[i];
    timeLeft=L.seconds;
    obstacles.length=0; goodies.length=0; crumbs.length=0; particles.length=0; confetti.length=0;
    speed=L.speedBase;
    player.x=Math.max(120, W*0.2);
    player.y=H - 0.22*H;
    player.r=Math.max(18, Math.min(30, Math.floor(H*0.035)));
    player.vy=0; player.onGround=true; player.jumps=0; player.shield=0; player.boost=0;
    toast('–£—Ä–æ–≤–µ–Ω—å: '+L.name+' ‚Ä¢ –î–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫');
    ui.level.textContent='–£—Ä–æ–≤–µ–Ω—å: '+L.name;
  }

  // Toasts
  const memos=['–§–æ—Ç–æ–æ—Ç—á—ë—Ç —Å—Ä–æ—á–Ω–æ','ERP ¬´—É–ø–∞–ª¬ª, –¥–µ—Ä–∂–∏–º—Å—è','–ù–µ—Ç —Å—Ç–æ–∫–∞ –Ω–∞ –†–¶ ‚Äî –ª–∞–¥–Ω–æ','–ë–µ–∑ ERID ‚ú®','–ü—Ä–µ–ø–∞–∫ –∑–∞—à—ë–ª!','OOS –∑–∞–∫—Ä—ã—Ç üòé','GM: KPI? ‚Äî –ë—É–¥–µ—Ç','–î–∏–∑–∞–π–Ω –±–µ–∑ –ø—Ä–∞–≤–æ–∫!','–î–æ–ø—Å–∫–∏–¥–∫–∞ -3% üöÄ','SKU —Ä–∞—Å—à–∏—Ä–µ–Ω—ã'];
  let toastTimer=0, memoT=0;
  function toast(msg){ ui.toast.textContent=msg; ui.toast.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>ui.toast.classList.remove('show'),2200); }

  // Helpers
  function rect(x,y,w,h,f){ ctx.fillStyle=f; ctx.fillRect(x,y,w,h); }
  function circle(x,y,r,f){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle=f; ctx.fill(); }
  function rand(a,b){ return a + Math.random()*(b-a); }
  function randI(a,b){ return Math.floor(rand(a,b)); }

  // Background
  function drawBG(){
    const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0, SKY[levelIndex]); g.addColorStop(1,'#17182a');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    ctx.globalAlpha=.24;
    for (let i=0;i<3;i++){
      const base=H*.65 + i*10;
      ctx.beginPath(); ctx.moveTo(0,base);
      for (let x=0;x<=W;x+=12){ const y=base - 24*Math.sin((x*.003)+(i*1.7)+t*.7); ctx.lineTo(x,y); }
      ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
      ctx.fillStyle=THEME[i]; ctx.fill();
    }
    ctx.globalAlpha=1;
    rect(0,H*.82,W,H*.18,'#f7f2ff22');
  }

  function drawPlayer(){
    // shadow
    circle(player.x, H*.8, player.r*.9, 'rgba(0,0,0,.10)');
    // oreo layers
    circle(player.x-3, player.y+2, player.r, '#3b2f2f');
    circle(player.x, player.y, player.r*.78, '#fff');
    circle(player.x+2, player.y-2, player.r, '#4a3a3a');

    // emboss
    ctx.fillStyle='#2d2222';
    for (let i=0;i<12;i++){ const a=i/12*Math.PI*2; circle(player.x+Math.cos(a)*player.r*.6, player.y+Math.sin(a)*player.r*.6, 2, '#2d2222'); }

    // eyes (they're back!)
    const blink=(Math.sin(t*8)>-0.1);
    if (blink){ circle(player.x-6, player.y-4, 3, '#111'); circle(player.x+6, player.y-4, 3, '#111'); }
    else { rect(player.x-9,player.y-5,6,2,'#111'); rect(player.x+3,player.y-5,6,2,'#111'); }
    ctx.strokeStyle='#111'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(player.x, player.y+6, 7, .15*Math.PI, .85*Math.PI); ctx.stroke();

    if (player.shield>0){ ctx.strokeStyle='#00d6ff'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(player.x, player.y, player.r+4, 0, Math.PI*2); ctx.stroke(); }
  }

  // Spawns
  let spawnT=0.2, goodieT=0.8, crumbT=0.3; // start fast
  function spawnObstacle(){
    const S=levels[levelIndex].spawn; const r=Math.random();
    let type = r<S.cube ? 'cube' : (r<S.cube+S.fall ? 'fall' : 'wall');
    if (type==='cube'){ const s=randI(player.r*1.0, player.r*1.4); obstacles.push({type,x:W+40,y:H*.82-s,w:s,h:s,vx:0,vy:0}); }
    else if (type==='fall'){ const s=randI(player.r*0.9, player.r*1.3); obstacles.push({type,x:W+randI(0,60),y:-s,w:s,h:s,vx:-speed*.12,vy:rand(2.6,3.6)}); }
    else { const w=randI(player.r*1.8, player.r*2.4), h=randI(player.r*0.9, player.r*1.2); obstacles.push({type,x:W+40,y:H*.82-h,w,h,vx:0,vy:0}); }
  }
  function spawnGoodie(){
    const B=levels[levelIndex].bonus; const r=Math.random();
    let type = r<B.discount ? 'discount' : (r<B.discount+B.prepack ? 'prepack' : 'erid');
    const y=rand(H*.45,H*.72);
    goodies.push({type,x:W+40,y,r: Math.max(12, Math.floor(player.r*.7)), got:false});
  }
  function spawnCrumbs(){
    const num = randI(4,7), baseX = W + 40, baseY = rand(H*.48, H*.75), spacing = Math.max(28, Math.floor(player.r*1.25));
    for (let i=0;i<num;i++){ crumbs.push({x: baseX + i*spacing, y: baseY - Math.sin(i/num*Math.PI)*Math.max(10, player.r*0.8), r: Math.max(6, Math.floor(player.r*0.35)), got:false}); }
  }

  // Update
  function update(dt){
    if (state!=='running') return;
    t+=dt; timeLeft-=dt;
    if (timeLeft<=0){ levelIndex++; if (levelIndex>=levels.length){ win(); return; } setupLevel(levelIndex); }

    speed = levels[levelIndex].speedBase + Math.min(3, Math.floor(t/12));
    if (player.boost>0){ speed += 1.5; player.boost -= dt; }

    // Physics
    player.vy += H*0.00155; // gravity
    player.y += player.vy;
    const gy=H*.78;
    if (player.y>gy){
      player.y=gy; player.vy=0;
      if (!player.onGround){ player.onGround=true; player.jumps=0; }
    }

    // Spawns
    spawnT-=dt; if (spawnT<=0){ spawnObstacle(); spawnT=rand(0.85,1.55); }
    goodieT-=dt; if (goodieT<=0){ spawnGoodie(); goodieT=rand(1.0,1.6); }
    crumbT-=dt; if (crumbT<=0){ spawnCrumbs(); crumbT=rand(0.85,1.35); }

    // Move
    for (const o of obstacles){ o.x -= speed + (o.vx||0); o.y += o.vy||0; if (o.type==='fall' && o.y>H*.82-o.h){ o.y=H*.82-o.h; o.vy=0; } }
    for (let i=obstacles.length-1;i>=0;i--){ if (obstacles[i].x + obstacles[i].w < -40) obstacles.splice(i,1); }

    for (const g of goodies){ g.x -= speed*.84; }
    for (let i=goodies.length-1;i>=0;i--){ if (goodies[i].x < -40 || goodies[i].got) goodies.splice(i,1); }

    for (const c of crumbs){ c.x -= speed*.9; }
    for (let i=crumbs.length-1;i>=0;i--){ if (crumbs[i].x < -40 || crumbs[i].got) crumbs.splice(i,1); }

    // Collisions
    for (const o of obstacles){
      if (circleRect(player.x, player.y, player.r*0.85, o.x,o.y,o.w,o.h)){
        if (player.shield>0){ player.shield=0; spark(o.x+o.w/2,o.y+o.h/2,'#00d6ff'); o.x=-999; }
        else { gameOver(); return; }
      }
    }
    for (const g of goodies){
      if (!g.got && Math.hypot(player.x-g.x, player.y-g.y) < player.r + g.r){
        g.got=true; if (g.type==='discount'){ player.boost=3.0; toast('–î–æ–ø—Å–∫–∏–¥–∫–∞ +3% üöÄ'); }
        else if (g.type==='prepack'){ player.shield=7.0; toast('–ü—Ä–µ–ø–∞–∫ ‚Äî —â–∏—Ç –Ω–∞ 7 —Å–µ–∫ üõ°Ô∏è'); }
        else { confettiBurst(24); toast('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ –±–µ–∑ ERID ‚ú®'); }
      }
    }
    for (const c of crumbs){
      if (!c.got && Math.hypot(player.x-c.x, player.y-c.y) < player.r + c.r){
        c.got = true; score += 1; spark(c.x,c.y,'#6d3b2a');
      }
    }

    ui.score.textContent='–û—á–∫–∏ (–∫—Ä–æ—à–∫–∏): '+score;
    ui.best.textContent='–†–µ–∫–æ—Ä–¥: '+Math.max(best, score);
    ui.status.textContent=`–û—Å—Ç–∞–ª–æ—Å—å: ${Math.max(0, Math.ceil(timeLeft))}—Å`;
  }

  function circleRect(cx,cy,cr, rx,ry,rw,rh){ const nx=Math.max(rx,Math.min(cx,rx+rw)); const ny=Math.max(ry,Math.min(cy,ry+rh)); const dx=cx-nx, dy=cy-ny; return dx*dx + dy*dy < cr*cr; }

  // FX
  function spark(x,y,color){ for (let i=0;i<10;i++){ particles.push({x,y, vx:rand(-2,2), vy:rand(-3,-0.5), life:rand(0.4,0.9), color: color||'#00d6ff'}); } }
  function confettiBurst(n){ for (let i=0;i<n;i++){ confetti.push({x:rand(0,W), y:rand(-40,-10), vx:rand(-0.5,0.5), vy:rand(2,4), life:rand(1,2), color:(i%2?PURPLE:BLUE)}); } }

  function render(){
    drawBG();
    // obstacles
    for (const o of obstacles){
      if (o.type==='cube'){ rect(o.x,o.y,o.w,o.h,'#ff4b6e'); label(o,'OOS'); }
      else if (o.type==='fall'){ rect(o.x,o.y,o.w,o.h,'#e8a36b'); for (let k=0;k<o.w;k+=6){ rect(o.x+k,o.y+2,3,o.h-4,'#d1844a'); } label(o,'–ù–µ—Ç —Å—Ç–æ–∫–∞'); }
      else { rect(o.x,o.y,o.w,o.h,'#ffb84b'); label(o,'ERP —É–ø–∞–ª'); }
    }
    // goodies
    for (const g of goodies){
      if (g.type==='discount'){ rect(g.x-16,g.y-12,32,24,BLUE); ctx.fillStyle='#fff'; ctx.font=`${Math.max(10, Math.floor(player.r*.6))}px sans-serif`; ctx.fillText('+3%', g.x-12, g.y+5); }
      else if (g.type==='prepack'){ circle(g.x,g.y,Math.max(12, Math.floor(player.r*.7))+2,'#00d6ff'); circle(g.x,g.y,Math.max(12, Math.floor(player.r*.7))-4,'#bff2ff'); }
      else { ctx.fillStyle=PURPLE; star(g.x,g.y,Math.max(12, Math.floor(player.r*.7))+4, Math.max(12, Math.floor(player.r*.7))-2, 6); }
    }
    // crumbs
    for (const c of crumbs){ circle(c.x, c.y, Math.max(6, Math.floor(player.r*0.35)), '#6d3b2a'); }

    // particles
    for (let i=particles.length-1;i>=0;i--){ const p=particles[i]; ctx.globalAlpha=Math.max(0,p.life); rect(p.x,p.y,3,3,p.color||'#00d6ff'); ctx.globalAlpha=1; p.x+=p.vx; p.y+=p.vy; p.vy+=0.06; p.life-=0.02; if (p.life<=0) particles.splice(i,1); }
    // confetti
    for (let i=confetti.length-1;i>=0;i--){ const c=confetti[i]; rect(c.x,c.y,4,8,c.color); c.x+=c.vx; c.y+=c.vy; c.vy+=0.02; c.life-=0.01; if (c.life<=0) confetti.splice(i,1); }

    // player
    drawPlayer();
  }

  function label(o, text){ ctx.fillStyle='#1d133d'; ctx.font=`${Math.max(10, Math.floor(player.r*.6))}px sans-serif`; ctx.fillText(text, o.x+6, o.y-6); }
  function star(x,y,outer,inner,points){ ctx.beginPath(); for (let i=0;i<points*2;i++){ const ang=Math.PI*i/points; const r=(i%2===0?outer:inner); ctx.lineTo(x+Math.cos(ang)*r, y+Math.sin(ang)*r); } ctx.closePath(); ctx.fill(); }

  // LOOP
  function loop(ts){ const now = ts || performance.now(); const dt=Math.min(0.05, (now-last)/1000 || 0); last=now; if (state==='running') update(dt); render(); requestAnimationFrame(loop); } requestAnimationFrame(loop);

  // Controls ‚Äî attach only after start
  function handleJump(){
    if (state!=='running') return;
    if (player.onGround && player.jumps===0){ player.vy = -Math.max(12, H*0.024); player.onGround=false; player.jumps=1; return; }
    if (!player.onGround && player.jumps===1){ player.vy = -Math.max(12, H*0.024); player.jumps=2; }
  }
  function attachGameplayInputs(){
    canvas.addEventListener('pointerdown', handleJump, {passive:true});
    canvas.addEventListener('touchstart', handleJump, {passive:true});
    canvas.addEventListener('mousedown', handleJump);
    window.addEventListener('keydown', e=>{ if (e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); handleJump(); } if (e.code==='KeyP'){ togglePause(); } }, {passive:false});
  }

  // Start / Pause / Restart
  ui.startBtn.addEventListener('click', ()=>{ if (state==='start'){ ui.start.classList.add('hidden'); resetAll(); attachGameplayInputs(); }}, {passive:true});
  ui.pauseBtn.addEventListener('click', togglePause);
  ui.restartBtn.addEventListener('click', ()=>{ ui.over.classList.add('hidden'); ui.victory.classList.add('hidden'); resetAll(); });
  function togglePause(){ if (state==='running'){ state='paused'; ui.pause.classList.remove('hidden'); } else if (state==='paused'){ state='running'; ui.pause.classList.add('hidden'); } }

  function gameOver(){ state='over'; best=Math.max(best, score); localStorage.setItem('mdz_best_crumbs', best); document.getElementById('overMsg').textContent=`–ö—Ä–æ—à–µ–∫ —Å–æ–±—Ä–∞–Ω–æ: ${score} ‚Ä¢ –†–µ–∫–æ—Ä–¥: ${best}`; ui.over.classList.remove('hidden'); }
  function win(){ state='victory'; best=Math.max(best, score); localStorage.setItem('mdz_best_crumbs', best); ui.victory.classList.remove('hidden'); typeCredits(`Developed by:\nŒõl—î–∫—ÅŒ±ndr R√∏d—ñonœÉv & Œõl—îx—îy Bl–ÜnœÉv`); confettiBurst(80); }

  // Countdown 3-2-1 before run (visible feedback in Safari)
  function startCountdown(){
    let n=3; ui.count.textContent=n; ui.count.classList.remove('hidden');
    const tick=()=>{ n--; if(n>0){ ui.count.textContent=n; setTimeout(tick, 600);} else { ui.count.classList.add('hidden'); state='running'; } };
    setTimeout(tick, 600);
  }

  function typeCredits(text){
    ui.credits.textContent = ''; let i=0;
    (function tick(){ ui.credits.textContent = text.slice(0,i) + (i%2?'':'‚ñà'); i++; if (i<=text.length) setTimeout(tick,28); })();
  }

  // Safety: show errors as a small banner so we see them –Ω–∞ –ø—Ä–æ–¥–µ
  window.addEventListener('error', e=>{ ui.debug.textContent = (e && e.message) ? e.message : 'Script error'; ui.debug.classList.add('show'); });

})();</script>
</body>
</html>
