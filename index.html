<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Mondelez Runner — KPI 120%</title>
<meta name="description" content="3‑lane FMCG runner. Дойди до 3‑го уровня и закрой год на 120% KPI." />
<meta name="theme-color" content="#2a2740" />
<style>
  :root{
    --fg:#f6f6f9;
    --muted:#b9b9c9;
    --accent:#7b5cf1;
    --accent2:#8be1ff;
    --danger:#ff5c7a;
    --success:#56f29c;
    --bg:#1d1a2b;
    --panel:rgba(0,0,0,.25);
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Segoe UI", Arial;}
  #wrap{position:fixed; inset:0; display:flex; align-items:stretch; justify-content:stretch;}
  canvas{display:block; width:100%; height:100%; background:#221f33;}
  /* HUD */
  .hud{pointer-events:none; position:fixed; inset:0; padding: max(10px, var(--safe-top)) 10px max(10px, var(--safe-bottom)) 10px; display:flex; flex-direction:column;}
  .topbar{display:flex; justify-content:space-between; align-items:center; gap:10px;}
  .pill{pointer-events:auto; backdrop-filter: blur(6px); background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:8px 12px; box-shadow:var(--shadow);}
  .stat{font-weight:600; letter-spacing:.3px;}
  .stat small{color:var(--muted); font-weight:500; margin-left:6px;}
  .btns{display:flex; gap:6px;}
  .btn{pointer-events:auto; user-select:none; border:1px solid rgba(255,255,255,.1); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); color:var(--fg); padding:8px 12px; border-radius:12px; font-weight:600; cursor:pointer; box-shadow:var(--shadow);}
  .btn:active{transform:translateY(1px);}
  .centerOverlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;}
  .big{font-size: clamp(36px, 8vw, 80px); font-weight:800; text-shadow:0 6px 24px rgba(0,0,0,.5); letter-spacing:1px;}
  .titleCard{position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:22px; background: radial-gradient(1200px 800px at 50% 20%, rgba(139,225,255,.08), transparent), radial-gradient(800px 600px at 70% 80%, rgba(123,92,241,.12), transparent);}
  .title{font-weight:900; font-size: clamp(28px, 7.5vw, 64px); letter-spacing:.5px; text-align:center;}
  .subtitle{opacity:.9; text-align:center; max-width:min(90%,800px); line-height:1.35;}
  .startBtn{pointer-events:auto; padding:14px 22px; border-radius:14px; font-weight:800; letter-spacing:.4px; border:0; background:linear-gradient(135deg, var(--accent), var(--accent2)); color:#0f0e16; cursor:pointer; box-shadow: 0 12px 30px rgba(123,92,241,.45), 0 6px 18px rgba(139,225,255,.2);}
  .startBtn:active{transform:translateY(1px);}
  .credits{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#7dffb7; background:rgba(20,24,20,.35); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow);}
  .credits .cursor{display:inline-block; width:10px; background:#7dffb7; margin-left:4px; animation:blink 1s steps(1) infinite;}
  @keyframes blink{50%{opacity:0;}}
  /* combo bar */
  .combobar{position:fixed; left:50%; transform:translateX(-50%); bottom: calc(12px + var(--safe-bottom)); width:min(540px, 86vw); height:12px; border-radius: 999px; background:rgba(255,255,255,.08); overflow:hidden; box-shadow:var(--shadow);}
  .combofill{height:100%; width:0%; background:linear-gradient(90deg, #6cf8c7, #7b5cf1); transition: width .15s;}
  .combotxt{position:absolute; width:100%; text-align:center; font-size:12px; top:-20px; color:var(--muted); font-weight:700; letter-spacing:.6px;}
  /* soft keys mobile */
  .softkeys{position:fixed; inset:auto 0 calc(12px + var(--safe-bottom)) 0; display:flex; justify-content:center; gap:8px; pointer-events:none;}
  .softkeys .btn{pointer-events:auto; padding:12px 14px; min-width:56px;}
  @media (hover:none) and (pointer:coarse){
    .softkeys{display:flex;}
  }
  @media (hover:hover){ .softkeys{display:none;} }
  /* toasts */
  .toasts{position:fixed; right:10px; bottom: calc(60px + var(--safe-bottom)); display:flex; flex-direction:column; gap:8px; max-width:min(90vw,380px);}
  .toast{background:rgba(20,20,40,.75); border:1px solid rgba(255,255,255,.08); border-left:4px solid var(--accent); padding:10px 12px; border-radius:10px; box-shadow:var(--shadow); font-weight:600; letter-spacing:.2px;}
  /* level tag */
  .leveltag{position:fixed; left:10px; bottom: calc(60px + var(--safe-bottom)); background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.1); padding:8px 12px; border-radius:12px; box-shadow:var(--shadow); font-weight:700;}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>
  <div class="hud">
    <div class="topbar">
      <div class="pill stat" id="scoreBox">Очки: <span id="score">0</span> <small>Рекорд: <span id="best">0</span></small></div>
      <div class="pill stat" id="statusBox">Уровень: <span id="level">1</span> / 3</div>
      <div class="btns">
        <button class="btn" id="btnMute">Звук: выкл</button>
        <button class="btn" id="btnPause">Пауза</button>
        <button class="btn" id="btnRestart">Заново</button>
      </div>
    </div>
  </div>
  <div class="combobar">
    <div class="combotxt" id="combotxt">COMBO ×1</div>
    <div class="combofill" id="combofill"></div>
  </div>
  <div class="softkeys">
    <button class="btn" id="softLeft">◀</button>
    <button class="btn" id="softRight">▶</button>
    <button class="btn" id="softJump">JUMP</button>
  </div>
  <div class="toasts" id="toasts"></div>
  <div class="leveltag" id="levelTag">Склад РЦ</div>
  <div class="centerOverlay" id="overlay" style="display:none;">
    <div class="big" id="overlayText"></div>
  </div>
  <div class="titleCard" id="titleCard">
     <div class="title">MONDELEZ RUNNER</div>
     <div class="subtitle">КАМ мчится к закрытию года. Собирай «шоколадные крошки», используй <b>двойной прыжок</b> избегай «ERP упал» и «нет стока». Пройди 3 уровня и закрой год на <b>120% KPI</b>.</div>
     <button class="startBtn" id="startBtn">START</button>
     <div class="credits" id="credits">Developed by: <span id="hackText"></span><span class="cursor"></span></div>
  </div>
</div>
<script>
(function(){
'use strict';

// ---------- utils
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const rand = (a,b)=>Math.random()*(b-a)+a;
const pick = arr => arr[(Math.random()*arr.length)|0];

// ---------- audio: simple WebAudio beeps (no external assets)
const SFX = (()=>{
  const ctx = new (window.AudioContext||window.webkitAudioContext||function(){return {}})();
  let enabled = false;
  function tone(freq=440, dur=0.08, type='sine', gain=0.04){
    if(!ctx.createOscillator) return;
    const t0 = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.setValueAtTime(gain, t0);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    o.connect(g); g.connect(ctx.destination);
    o.start(t0); o.stop(t0 + dur);
  }
  return {
    resume(){try{ctx.resume();}catch(e){};},
    enable(){enabled = true; this.resume();},
    disable(){enabled = false;},
    get enabled(){return enabled;},
    jump(){ if(enabled) tone(620, .10, 'square', .05); },
    double(){ if(enabled) tone(760, .12, 'square', .055); },
    slide(){ if(enabled) tone(260, .14, 'sawtooth', .045); },
    coin(){ if(enabled) tone(1100, .06, 'triangle', .05); },
    bonus(){ if(enabled) tone(880, .18, 'sine', .06); },
    hit(){ if(enabled) { tone(120, .12, 'sawtooth', .09); setTimeout(()=>tone(90,.16,'sawtooth',.08),60);} },
    level(){ if(enabled) tone(520, .3, 'square', .07); },
    win(){ if(enabled){[640,720,840,980].forEach((f,i)=>setTimeout(()=>tone(f,.12,'triangle',.07), i*130));} }
  };
})();

// ---------- DOM refs
const canvas = document.getElementById('game');
const ctx2d = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const bestEl = document.getElementById('best');
const levelEl = document.getElementById('level');
const btnMute = document.getElementById('btnMute');
const btnPause = document.getElementById('btnPause');
const btnRestart = document.getElementById('btnRestart');
const overlay = document.getElementById('overlay');
const overlayText = document.getElementById('overlayText');
const titleCard = document.getElementById('titleCard');
const startBtn = document.getElementById('startBtn');
const toasts = document.getElementById('toasts');
const combofill = document.getElementById('combofill');
const combotxt = document.getElementById('combotxt');
const levelTag = document.getElementById('levelTag');
const hackText = document.getElementById('hackText');
const softLeft = document.getElementById('softLeft');
const softRight = document.getElementById('softRight');
const softJump = document.getElementById('softJump');

// hacker credits typing
(function typeCredits(){
  const text = "Λlєксαndr Rødіonσv • Λlєxєy Blіnσv";
  let i=0;
  const tick=()=>{
    hackText.textContent = text.slice(0,i);
    if(i<text.length){ i++; setTimeout(tick, 60+Math.random()*80); }
  };
  tick();
})();

// viewport & lanes
let W=0, H=0, DPR=1;
function resize(){
  DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  W = Math.floor(window.innerWidth * DPR);
  H = Math.floor(window.innerHeight * DPR);
  canvas.width = W; canvas.height = H;
  canvas.style.width = '100%'; canvas.style.height = '100%';
}
window.addEventListener('resize', resize, {passive:true}); resize();

// game constants
const LANES = 3;
const LANE_W = ()=> Math.min(W*0.22, 260*DPR);
const ROAD_W = ()=> LANE_W()*LANES;
const ROAD_X = ()=> (W - ROAD_W())/2;
const FLOOR_Y = ()=> H*0.78;
const G = ()=> 0.0016*H; // gravity scales with screen
const JUMP_V = ()=> 0.032*H;
const DOUBLE_JUMP_V = ()=> 0.028*H;
const SLIDE_TIME = 520;
const BASE_SPEED = ()=> Math.max(0.5*DPR, 8*DPR); // px per frame baseline
const COLOR_SKY = ['#28253a', '#262a3b', '#26243a']; // per level

// levels
const LEVELS = [
  { name:'Склад РЦ', sky:COLOR_SKY[0], length: 12000, speedMul:1.00 },
  { name:'Магазин', sky:COLOR_SKY[1], length: 15000, speedMul:1.04 },
  { name:'Переговорка', sky:COLOR_SKY[2], length: 18000, speedMul:1.08 }
];

// state
let state = 'TITLE'; // TITLE, COUNTDOWN, RUN, PAUSE, LEVEL_END, GAME_END
let levelIdx = 0;
let t = 0;
let speed = BASE_SPEED();
let scrollX = 0;
let distance = 0;
let score = 0;
let best = Number(localStorage.getItem('mdz_best')||0);
bestEl.textContent = best;
let combo = 1;
let comboProg = 0; // 0..1
let comboDecay = 0;
let shieldMs = 0;
let countdown = 3;
let lastFrame = performance.now();

// player
const player = {
  lane:1,
  targetLane:1,
  x(){ return ROAD_X() + (this.lane+0.5)*LANE_W(); },
  y:0,
  vy:0,
  onGround:true,
  canDouble:false,
  sliding:false,
  slideUntil:0,
  w(){ return LANE_W()*0.5; },
  h(){ return this.sliding ? LANE_W()*0.35 : LANE_W()*0.8; },
  draw(){
    const px = this.x();
    const py = FLOOR_Y() - this.h() - this.y;
    // cookie body
    const r = this.h()/2;
    ctx2d.save();
    ctx2d.translate(px, py+r);
    // shadow
    ctx2d.fillStyle = 'rgba(0,0,0,.25)';
    ctx2d.beginPath();
    ctx2d.ellipse(0, this.h()+8*DPR, this.w()*0.52, this.w()*0.22, 0, 0, Math.PI*2);
    ctx2d.fill();
    // body
    const grad = ctx2d.createLinearGradient(0,-r,0,r);
    grad.addColorStop(0,'#f2d4b6'); grad.addColorStop(1,'#d9a87d');
    ctx2d.fillStyle = grad;
    ctx2d.strokeStyle = '#8a5a32'; ctx2d.lineWidth = 4*DPR;
    ctx2d.beginPath(); ctx2d.arc(0,0,r,0,Math.PI*2); ctx2d.fill(); ctx2d.stroke();
    // chocolate chips
    ctx2d.fillStyle = '#5a341c';
    for(let i=0;i<6;i++){
      const a = i*Math.PI/3 + (t*0.001+i*0.5);
      const rr = r*0.55;
      ctx2d.beginPath();
      ctx2d.arc(Math.cos(a)*rr, Math.sin(a)*rr*0.6, r*0.10, 0, Math.PI*2);
      ctx2d.fill();
    }
    // face
    ctx2d.fillStyle = '#3a220f';
    ctx2d.beginPath(); ctx2d.arc(-r*0.25,-r*0.15,r*0.08,0,Math.PI*2); ctx2d.fill();
    ctx2d.beginPath(); ctx2d.arc(+r*0.25,-r*0.15,r*0.08,0,Math.PI*2); ctx2d.fill();
    ctx2d.strokeStyle = '#3a220f'; ctx2d.lineWidth = 4*DPR; ctx2d.lineCap = 'round';
    ctx2d.beginPath(); ctx2d.moveTo(-r*0.2,r*0.15); ctx2d.quadraticCurveTo(0,r*0.28,r*0.2,r*0.15); ctx2d.stroke();
    // shield aura
    if(shieldMs>0){
      const pct = (shieldMs%600)/600;
      ctx2d.strokeStyle = 'rgba(123,92,241,.9)';
      ctx2d.lineWidth = 6*DPR;
      ctx2d.beginPath(); ctx2d.arc(0,0,r+8*DPR + pct*6*DPR,0,Math.PI*2); ctx2d.stroke();
    }
    ctx2d.restore();
  }
};

// entities
const obstacles=[]; // {x,lane,type,height}
const coins=[];     // {x,lane,kind} kind: 'crumb','bonus3','prepak','erid'
let spawnX = 800;   // next spawn forward distance in px
function resetLevel(){
  distance = 0; scrollX = 0; obstacles.length=0; coins.length=0;
  player.vy=0; player.y=0; player.onGround=true; player.canDouble=false; player.sliding=false;
  spawnX = 800;
  shieldMs = 0; combo = 1; comboProg = 0; comboDecay = 0;
  speed = BASE_SPEED()*LEVELS[levelIdx].speedMul*1.04; // +4% vs базовое
  levelEl.textContent = (levelIdx+1);
  levelTag.textContent = LEVELS[levelIdx].name;
  SFX.level();
}
function spawnWave(){
  // probabilistic wave: either coins run, or mixed obstacles
  const base = distance + W*0.8 + rand(200, 500);
  const lanes = [0,1,2];
  if(Math.random()<0.5){
    // coin line
    const l = pick(lanes);
    for(let i=0;i<6;i++){
      coins.push({x: base + i*LANE_W()*0.6, lane:l, kind:'crumb'});
    }
    // chance of bonus at the end
    const bonusRoll = Math.random();
    if(bonusRoll<0.33) coins.push({x: base+LANE_W()*3.8, lane:l, kind:'bonus3'});
    else if(bonusRoll<0.66) coins.push({x: base+LANE_W()*3.8, lane:l, kind:'prepak'});
    else coins.push({x: base+LANE_W()*3.8, lane:l, kind:'erid'});
  }else{
    // obstacles + some coins
    const pattern = (Math.random()*3)|0; // 0..2
    if(pattern===0){
      // low obstacle replaced by short wall
      obstacles.push({x:base, lane:pick(lanes), type:'wall', h:LANE_W()*0.65});
    }else if(pattern===1){
      // wall "ERP upal"
      obstacles.push({x:base, lane:pick(lanes), type:'wall', h:LANE_W()*0.9});
    }else{
      // moving cart: choose lane and add a coin line to lure
      const l = pick(lanes);
      obstacles.push({x:base, lane:l, type:'cart', h:LANE_W()*0.7, phase: Math.random()*Math.PI});
      for(let i=0;i<4;i++) coins.push({x: base + i*LANE_W()*0.5, lane: (l+ (i%2?1:-1)+3)%3, kind:'crumb'});
    }
  }
  spawnX = base + rand(700, 1100);
}
function drawBackground(){
  const sky = LEVELS[levelIdx].sky;
  // vignette sky
  const gradSky = ctx2d.createRadialGradient(W*0.6, H*0.3, H*0.1, W*0.5, H*0.5, Math.max(W,H));
  gradSky.addColorStop(0, sky);
  gradSky.addColorStop(1, '#151226');
  ctx2d.fillStyle = gradSky;
  ctx2d.fillRect(0,0,W,H);

  // candy parallax layers
  const roadX = ROAD_X(), roadW = ROAD_W();
  const gy = FLOOR_Y();
  const layers = [
    {k:0.15, col:'#ffe1ec'}, // marshmallow far
    {k:0.35, col:'#ffd58f'}, // caramel
    {k:0.65, col:'#c6f0ff'}, // glaze
  ];
  layers.forEach((L,i)=>{
    ctx2d.save();
    ctx2d.globalAlpha = 0.08 + i*0.04;
    for(let x=-200*DPR; x<W+200*DPR; x+= 180*DPR){
      const xx = (x - (scrollX*L.k)%(180*DPR));
      const h = 80*DPR + (i*24*DPR);
      const y = gy - (140+i*40)*DPR;
      ctx2d.fillStyle = L.col;
      ctx2d.beginPath();
      ctx2d.ellipse(xx, y, 90*DPR, h, 0, 0, Math.PI*2);
      ctx2d.fill();
    }
    ctx2d.restore();
  });

  // ground glossy
  const grd = ctx2d.createLinearGradient(0,gy,0,H);
  grd.addColorStop(0,'#332b4d'); grd.addColorStop(1,'#1a1628');
  ctx2d.fillStyle = grd;
  ctx2d.fillRect(0, gy, W, H-gy);

  // lane glow
  ctx2d.fillStyle = 'rgba(255,255,255,.08)';
  for(let i=1;i<LANES;i++){
    const x = roadX + i*LANE_W();
    for(let y=0;y<H;y+=28*DPR){
      ctx2d.fillRect(x-2*DPR, y+((scrollX/6)|0)%28*DPR, 4*DPR, 14*DPR);
    }
  }
}

function drawEntityRect(x, lane, h, color){
  const lx = ROAD_X() + (lane+0.1)*LANE_W();
  const rx = ROAD_X() + (lane+0.9)*LANE_W();
  const w = rx-lx;
  const y = FLOOR_Y() - h;
  ctx2d.fillStyle = color;
  ctx2d.fillRect(x - scrollX + lx, y, w, h);
}

// Toasts
function showToast(text, kind='info'){
  const el = document.createElement('div');
  el.className = 'toast';
  if(kind==='ok') el.style.borderLeftColor = 'var(--success)';
  if(kind==='bad') el.style.borderLeftColor = 'var(--danger)';
  el.textContent = text;
  toasts.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(6px)'; }, 1800);
  setTimeout(()=> el.remove(), 2300);
}

// controls
function moveLane(dir){
  const old = player.targetLane;
  player.targetLane = clamp(player.targetLane + dir, 0, LANES-1);
  player.lane = player.targetLane;
}
function doJump(){
  if(player.onGround){
    player.vy = JUMP_V();
    player.onGround = false;
    player.canDouble = true;
    SFX.jump();
  }else if(player.canDouble){
    player.vy = DOUBLE_JUMP_V();
    player.canDouble = false;
    SFX.double();
  }
}
function doSlide(){};
}
function endSlideIfNeeded(now){
  if(player.sliding && now > player.slideUntil){
    player.sliding = false;
  }
}

// keyboard
window.addEventListener('keydown', (e)=>{
  if(state==='TITLE') return;
  if(e.code==='ArrowLeft' || e.code==='KeyA') moveLane(-1);
  else if(e.code==='ArrowRight' || e.code==='KeyD') moveLane(+1);
  else if(e.code==='ArrowUp' || e.code==='Space') doJump();
  else if(e.code==='ArrowDown' || e.code==='KeyS') // slide removed
  else if(e.code==='KeyP'){ togglePause(); }
});

// touch/swipe
let touchStart=null;
window.addEventListener('touchstart', (e)=>{
  if(state==='TITLE') return;
  if(!SFX.enabled) { SFX.enable(); btnMute.textContent='Звук: вкл'; }
  const t = e.changedTouches[0];
  touchStart = {x:t.clientX, y:t.clientY, time: performance.now()};
},{passive:true});
window.addEventListener('touchend', (e)=>{
  if(state==='TITLE') return;
  const t = e.changedTouches[0];
  if(!touchStart) return;
  const dx = t.clientX - touchStart.x;
  const dy = t.clientY - touchStart.y;
  const adx = Math.abs(dx), ady = Math.abs(dy);
  const dt = performance.now() - touchStart.time;
  const SW = 24; // px threshold
  if(adx>ady && adx>SW){
    moveLane(dx<0?-1:+1);
  }else if(ady>adx && ady>SW){
    if(dy<0) doJump(); else // slide removed
  }else{
    // tap => jump
    doJump();
  }
  touchStart=null;
},{passive:true});

// soft keys
softLeft.onclick = ()=> moveLane(-1);
softRight.onclick = ()=> moveLane(+1);
softJump.onclick = ()=> doJump();

// buttons
btnMute.onclick = ()=>{
  if(SFX.enabled){ SFX.disable(); btnMute.textContent='Звук: выкл'; }
  else { SFX.enable(); btnMute.textContent='Звук: вкл'; SFX.resume(); SFX.coin(); }
};
btnPause.onclick = ()=> togglePause();
btnRestart.onclick = ()=> restartGame();

function togglePause(){
  if(state==='RUN'){ state='PAUSE'; showOverlay('ПАУЗА'); }
  else if(state==='PAUSE'){ hideOverlay(); state='RUN'; lastFrame=performance.now(); }
}
function showOverlay(txt){
  overlayText.textContent = txt;
  overlay.style.display = 'flex';
}
function hideOverlay(){ overlay.style.display='none'; }

startBtn.onclick = ()=>{
  titleCard.style.display = 'none';
  startCountdown();
};
function startCountdown(){
  state='COUNTDOWN';
  countdown=3;
  nextTickCountdown();
}
function nextTickCountdown(){
  showOverlay(String(countdown));
  if(countdown<=0){
    hideOverlay();
    resetLevel(); state='RUN'; lastFrame=performance.now();
    return;
  }
  countdown--;
  setTimeout(nextTickCountdown, 700);
}

// collisions
function playerRect(){
  const w = player.w()*0.9, h = player.h()*0.9;
  const x = player.x();
  const y = FLOOR_Y() - player.h() - player.y;
  return {x:x-w/2, y:y, w:w, h:h};
}
function rectsOverlap(a,b){
  return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
}

function update(now){
  const dt = Math.min(40, now - lastFrame); lastFrame = now;
  if(state==='RUN'){
    t += dt;
    endSlideIfNeeded(now);
    // physics
    player.vy += -G()*dt/16;
    player.y += player.vy*dt/16;
    if(player.y<=0){ player.y=0; player.vy=0; player.onGround=true; player.sliding=false; player.canDouble=false; }
    // scroll
    const spd = speed;
    scrollX += spd; distance += spd;
    // spawn
    if(distance+W > spawnX) spawnWave();
    // move moving obstacles
    obstacles.forEach(o=>{
      if(o.type==='cart'){
        // small vertical bobbing
        o.phase += dt*0.006;
      }
    });
    // cleanup old
    while(obstacles.length && ROAD_X()+obstacles[0].x - scrollX + LANE_W()*0.9 < -200*DPR) obstacles.shift();
    while(coins.length && ROAD_X()+coins[0].x - scrollX + LANE_W()*0.9 < -200*DPR) coins.shift();
    // collisions
    const p = playerRect();
    // coins / bonuses
    for(let i=coins.length-1;i>=0;i--){
      const c = coins[i];
      const cx = ROAD_X() + (c.lane+0.1)*LANE_W() + c.x - scrollX;
      const cr = {x: cx, y: FLOOR_Y()-LANE_W()*0.8, w: LANE_W()*0.8, h: LANE_W()*0.8};
      if(rectsOverlap(p, cr)){
        if(c.kind==='crumb'){
          score += 1*combo;
          combo = Math.min(8, combo+0.05);
          comboProg = clamp(comboProg + 0.18, 0, 1);
          comboDecay = 1500;
          SFX.coin();
        }else if(c.kind==='bonus3'){
          score += 5*combo; showToast('Допскидка +3%  •  +5', 'ok'); SFX.bonus();
        }else if(c.kind==='prepak'){
          shieldMs = 7000; showToast('Препак — ЩИТ на 7s', 'ok'); SFX.bonus();
        }else if(c.kind==='erid'){
          score += 10*combo; showToast('Без ERID  •  +10', 'ok'); SFX.bonus();
        }
        coins.splice(i,1);
        scoreEl.textContent = score;
      }
    }
    // obstacle collisions
    for(let i=0;i<obstacles.length;i++){
      const o = obstacles[i];
      const ox = ROAD_X() + (o.lane+0.1)*LANE_W() + o.x - scrollX;
      const ow = LANE_W()*0.8;
      const or = {x: ox, y: FLOOR_Y()-o.h, w: ow, h: o.h};
      if(rectsOverlap(p, or)){
        if(shieldMs>0){
          shieldMs = 0; showToast('Щит поглотил удар', 'ok');
          obstacles.splice(i,1);
          SFX.hit();
          break;
        }else{
          SFX.hit();
          // reset to level start (checkpoint-style)
          showToast('Столкновение — рестарт уровня', 'bad');
          state='PAUSE'; showOverlay('☠');
          setTimeout(()=>{ hideOverlay(); resetLevel(); state='RUN'; lastFrame=performance.now(); }, 600);
          combo=1; comboProg=0; comboDecay=0;
          break;
        }
      }
    }
    // combo decay
    if(combo>1){
      comboDecay -= dt;
      if(comboDecay<=0){
        combo = Math.max(1, combo - 0.02*dt/16);
      }
    }
    // shield timer
    if(shieldMs>0) shieldMs = Math.max(0, shieldMs - dt);
    // finish level?
    if(distance >= LEVELS[levelIdx].length){
      levelIdx++;
      if(levelIdx>=LEVELS.length){
        state='LEVEL_END'; // lead to game end
        setTimeout(()=>gameWin(), 400);
      }else{
        state='LEVEL_END';
        showToast('Уровень пройден', 'ok');
        setTimeout(()=>{
          hideOverlay();
          startCountdown();
        }, 500);
      }
    }
    // UI
    combofill.style.width = ( (combo-1)/7 * 100 ).toFixed(1)+'%';
    combotxt.textContent = 'COMBO ×' + Math.max(1, Math.floor(combo));
    scoreEl.textContent = score;
  }
}

function draw(){
  drawBackground();
  // draw coins
  for(const c of coins){
    const x = ROAD_X() + (c.lane+0.5)*LANE_W() + c.x - scrollX;
    const y = FLOOR_Y() - LANE_W()*0.9;
    if(c.kind==='crumb'){
      // little chip
      ctx2d.fillStyle = '#5a341c';
      ctx2d.beginPath(); ctx2d.arc(x, y, LANE_W()*0.12, 0, Math.PI*2); ctx2d.fill();
      ctx2d.fillStyle = 'rgba(255,255,255,.15)';
      ctx2d.beginPath(); ctx2d.arc(x-3*DPR,y-4*DPR, LANE_W()*0.05, 0, Math.PI*2); ctx2d.fill();
    }else if(c.kind==='bonus3'){
      ctx2d.fillStyle = '#56f29c';
      ctx2d.fillRect(x-LANE_W()*0.16, y-LANE_W()*0.08, LANE_W()*0.32, LANE_W()*0.16);
      drawText('+3%', x, y+4*DPR, 16*DPR, '#11231a', 'center');
    }else if(c.kind==='prepak'){
      ctx2d.fillStyle = '#7b5cf1';
      ctx2d.beginPath(); ctx2d.arc(x, y, LANE_W()*0.16, 0, Math.PI*2); ctx2d.fill();
      drawText('препак', x, y+4*DPR, 14*DPR, '#0e0c18', 'center');
    }else if(c.kind==='erid'){
      ctx2d.fillStyle = '#8be1ff';
      ctx2d.fillRect(x-LANE_W()*0.18, y-LANE_W()*0.18, LANE_W()*0.36, LANE_W()*0.36);
      drawText('без ERID', x, y+4*DPR, 12*DPR, '#0a1b22', 'center');
    }
  }
  // draw obstacles
  for(const o of obstacles){
    const x = ROAD_X() + (o.lane+0.1)*LANE_W() + o.x - scrollX;
    if(o.type==='low'){
      drawEntityRect(o.x, o.lane, o.h, '#f2c94c'); // коробки
      drawText('низко', x+LANE_W()*0.32, FLOOR_Y()-o.h-4*DPR, 12*DPR, '#fff', 'center');
    }else if(o.type==='wall'){
      drawEntityRect(o.x, o.lane, o.h, '#ff6b7b'); // ERP upal
      drawText('ERP упал', x+LANE_W()*0.32, FLOOR_Y()-o.h-4*DPR, 12*DPR, '#fff', 'center');
    }else if(o.type==='cart'){
      const h = o.h + Math.sin(o.phase)*6*DPR;
      drawEntityRect(o.x, o.lane, h, '#6bb0ff');
      drawText('тележка', x+LANE_W()*0.32, FLOOR_Y()-h-4*DPR, 12*DPR, '#fff', 'center');
    }
  }
  // player
  player.draw();

  // center banners for level start/end
  if(state==='LEVEL_END'){
    drawCenterText('LEVEL CLEAR', 42*DPR, '#7dffb7');
  }else if(state==='PAUSE'){
    drawCenterText('PAUSE', 42*DPR, '#fff');
  }

  // KPI win overlay handled in gameWin()
}

function drawText(txt, x, y, size, color, align='left'){
  ctx2d.fillStyle = color;
  ctx2d.font = `700 ${size}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter`;
  ctx2d.textAlign = align;
  ctx2d.textBaseline = 'top';
  ctx2d.fillText(txt, x, y);
}
function drawCenterText(txt, size, color){
  drawText(txt, W/2, H*0.25, size, color, 'center');
}

// game loop
function frame(now){
  if(state==='RUN'){ update(now); }
  draw();
  requestAnimationFrame(frame);
}
requestAnimationFrame(frame);

// KPI WIN
function gameWin(){
  state='GAME_END';
  SFX.win();
  // update best
  if(score>best){ best=score; localStorage.setItem('mdz_best', String(best)); bestEl.textContent=best; }
  // fireworks confetti
  const start = performance.now();
  const id = setInterval(()=>{
    showToast('Год закрыт на 120% KPI', 'ok');
  }, 700);
  setTimeout(()=>clearInterval(id), 3000);

  // animated overlay text
  overlay.style.display='flex';
  let msg1 = 'Год закрыт на 120% KPI';
  let msg2 = 'Developed by:\nΛlєксαndr Rødіonσv & Λlєxєy Blіnσv █';
  let i=0, j=0;
  function type(){
    overlayText.style.whiteSpace='pre-line';
    overlayText.innerHTML = `<div style="font-weight:800; font-size:${clamp(28*DPR,28,56)}px; margin-bottom:12px; color:#7dffb7;">${msg1}</div>`+
      `<div style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#8be1ff; font-size:${clamp(16*DPR,14,24)}px;">${msg2.slice(0,j)}<span style="background:#8be1ff; display:inline-block; width:10px; height:1em; vertical-align:-2px; animation: blink 1s steps(1) infinite;"></span></div>`;
    if(j<msg2.length){ j++; setTimeout(type, 40+Math.random()*60); }
  }
  type();
  setTimeout(()=>{
    // show restart
    showToast('Tap/Enter — заново', 'info');
    window.addEventListener('keydown', restartOnce);
    window.addEventListener('touchstart', restartOnce, {once:true, passive:true});
  }, 1500);
  function restartOnce(){
    window.removeEventListener('keydown', restartOnce);
    restartGame();
  }
}

function restartGame(){
  overlay.style.display='none';
  titleCard.style.display='none';
  levelIdx=0; score=0; scoreEl.textContent=score;
  startCountdown();
}

// misc UX: initial overlay hidden, but ensure buttons work in TITLE
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden && state==='RUN') togglePause();
});

// Status: ready
console.log('Mondelez Runner ready');
})();
</script>
</body>
</html>
