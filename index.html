<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Mondelez Runner ‚Äî 3D v7 UltraTouch</title>
<meta name="theme-color" content="#ffeefb">
<style>
  :root { --accent:#7b61ff; --ui:#2b225a; --bg:#fff4fb; --mint:#00e6a3; --blue:#2b7bd4; --rose:#ff6b8a; }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #hud{position:fixed;inset:0;pointer-events:none;z-index:9999}
  .hud{position:absolute;left:12px;top:10px;color:#fff;text-shadow:0 3px 12px rgba(0,0,0,.45);font-weight:800}
  .hud .line{font-size:13px} .hud .big{font-size:16px;margin-bottom:2px}
  .btns{position:absolute;right:12px;top:10px;display:flex;gap:8px}
  .btn{pointer-events:auto;border:none;border-radius:12px;padding:10px 16px;background:var(--ui);color:#fff;font-weight:800;
       box-shadow:0 8px 26px rgba(0,0,0,.25);cursor:pointer;touch-action:manipulation}
  .btn.sec{background:var(--blue)}
  .toast{position:absolute;left:50%;transform:translateX(-50%);bottom:9vh;background:rgba(20,20,35,.92);color:#e7e7ff;padding:10px 14px;
         border:1px solid rgba(122,75,212,.4);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0;
         transition:opacity .25s,transform .25s;pointer-events:none;white-space:nowrap}
  .toast.show{opacity:1;transform:translate(-50%,-8px)}
  .banner{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .card{pointer-events:auto;max-width:min(960px,96vw);background:#fff;border:3px solid var(--accent);border-radius:20px;
        padding:20px 22px;color:#2b225a;text-align:center;box-shadow:0 22px 70px rgba(114,84,196,.25)}
  .start-title{font-size:clamp(24px,4vw,40px);margin:6px 0 10px}
  .dev{font-family:ui-monospace,Menlo,Consolas,monospace;color:var(--mint);text-shadow:0 0 8px rgba(0,255,149,.35);
       font-size:clamp(13px,2.2vw,18px);margin:6px 0 12px}
  .mini{opacity:.85;font-size:clamp(12px,2vw,15px)}
  .start-actions{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-top:14px}
  .btnlg{pointer-events:auto;border:none;border-radius:12px;padding:13px 20px;background:var(--ui);color:#fff;font-weight:900;
         box-shadow:0 10px 30px rgba(0,0,0,.25);cursor:pointer;touch-action:manipulation}
  .diff{background:#efe9ff;color:#2b225a;border:2px solid var(--accent)}
  .diff.easy{border-color:var(--mint)}.diff.mid{border-color:var(--blue)}.diff.hard{border-color:var(--rose)}
  .hidden{display:none}
  .count{position:absolute;left:50%;top:38%;transform:translate(-50%,-50%);color:#fff;font-weight:900;font-size:12vh;text-shadow:0 10px 50px rgba(0,0,0,.35);pointer-events:none}
  .pill{position:absolute;left:50%;top:12px;transform:translateX(-50%);pointer-events:none;background:rgba(255,255,255,.9);color:#1d1d2e;padding:6px 12px;border-radius:999px;border:2px solid #c9b7ff;font:12px/1.2 ui-monospace,Menlo,Consolas,monospace}
  .floating{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#fff;font-weight:900;text-shadow:0 0 12px rgba(0,0,0,.4);opacity:0;transition:opacity .2s, transform .4s}

  /* On-screen controls */
  .controls{position:fixed;inset:0;pointer-events:none}
  .zone{position:absolute;top:0;bottom:0;width:50%;pointer-events:auto}
  .zone.left{left:0}
  .zone.right{right:0}
  .softbtn{position:absolute;bottom:18px;right:16px;background:rgba(20,20,35,.65);color:#fff;border:2px solid rgba(255,255,255,.6);
           padding:12px 14px;border-radius:14px;font-weight:900;pointer-events:auto;touch-action:manipulation;user-select:none}
  .softrow{position:absolute;bottom:18px;left:16px;display:flex;gap:10px;pointer-events:auto}
  .softkey{background:rgba(20,20,35,.65);color:#fff;border:2px solid rgba(255,255,255,.6);padding:12px 14px;border-radius:14px;font-weight:900;touch-action:manipulation;user-select:none}
  .softbtn:active,.softkey:active{transform:translateY(2px);opacity:.9}
  .hint{position:absolute;left:50%;bottom:22px;transform:translateX(-50%);color:#003226;background:#bff2e8;border:2px solid #0acaa0;
        padding:6px 10px;border-radius:10px;font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;pointer-events:none}
</style>
</head>
<body>
<div id="hud">
  <div class="hud">
    <div class="line big" id="levelLabel">–£—Ä–æ–≤–µ–Ω—å: ‚Äî</div>
    <div class="line" id="scoreLabel">–û—á–∫–∏ (–∫—Ä–æ—à–∫–∏): 0</div>
    <div class="line" id="bestLabel">–†–µ–∫–æ—Ä–¥: 0</div>
    <div class="line" id="statusLabel"></div>
  </div>
  <div class="btns">
    <button class="btn" id="restartBtn">–ó–∞–Ω–æ–≤–æ</button>
    <button class="btn sec" id="pauseBtn">–ü–∞—É–∑–∞</button>
  </div>
  <div class="toast" id="toast">–¢–µ–∫—Å—Ç</div>
  <div class="count hidden" id="count">3</div>
  <div class="pill" id="pillTip">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ª–µ–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ ‚Äî —Å–≤–∞–π–ø—ã –ø–æ –ø–æ–ª–æ—Å–∞–º; –ø—Ä–∞–≤–∞—è ‚Äî –ø—Ä—ã–∂–æ–∫/—Å–ª–∞–π–¥; —É–¥–µ—Ä–∂–∞–Ω–∏–µ ‚Äî –æ–≥–æ–Ω—å</div>
  <div class="floating" id="floatTxt">+1</div>

  <div class="banner" id="startBanner">
    <div class="card">
      <div style="font-size:46px;margin-bottom:6px;">üç™üéÆüç≠</div>
      <div class="start-title">Mondelez Runner ‚Äî 3D v7 UltraTouch</div>
      <div class="dev">Œõl—î–∫—ÅŒ±ndr R√∏d—ñonœÉv ‚Ä¢ Œõl—îx—îy Bl—ñnœÉv</div>
      <div class="mini">–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–Ω—ã–µ –∂–µ—Å—Ç—ã: –ª–µ–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞ ‚Äî –ø–æ–ª–æ—Å—ã, –ø—Ä–∞–≤–∞—è ‚Äî –ø—Ä—ã–∂–æ–∫/—Å–ª–∞–π–¥, —É–¥–µ—Ä–∂–∞–Ω–∏–µ ‚Äî –∞–≤—Ç–æ—Å—Ç—Ä–µ–ª—å–±–∞. –ü–ª—é—Å –º—è–≥–∫–∏–µ —ç–∫—Ä–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏.</div>
      <div class="start-actions">
        <button class="btnlg diff easy" id="startEasy">ü•ß –õ–ï–ì–ö–û</button>
        <button class="btnlg diff mid"  id="startMid">üç´ –°–†–ï–î–ù–ï</button>
        <button class="btnlg diff hard" id="startHard">‚ö° –°–õ–û–ñ–ù–û</button>
      </div>
    </div>
  </div>
</div>

<!-- On-screen controls layer -->
<div class="controls" id="controls">
  <div class="zone left" id="zoneLeft" aria-label="–ü–æ–ª–æ—Å—ã"></div>
  <div class="zone right" id="zoneRight" aria-label="–ü—Ä—ã–∂–æ–∫/–°–ª–∞–π–¥"></div>
  <div class="softrow">
    <div class="softkey" id="btnLeft">‚óÄÔ∏é</div>
    <div class="softkey" id="btnRight">‚ñ∂Ô∏é</div>
  </div>
  <div class="softbtn" id="btnJump">JUMP</div>
  <div class="softbtn" id="btnSlide" style="right:96px">SLIDE</div>
  <div class="softbtn" id="btnShoot" style="right:176px">üéØ</div>
  <div class="hint" id="hint">–°–≤–∞–π–ø—ã —Å–ª–µ–≤–∞ ‚Äî –ø–æ–ª–æ—Å—ã ‚Ä¢ –¢–∞–ø —Å–ø—Ä–∞–≤–∞ ‚Äî –ø—Ä—ã–∂–æ–∫ ‚Ä¢ –°–≤–∞–π–ø –≤–Ω–∏–∑ —Å–ø—Ä–∞–≤–∞ ‚Äî —Å–ª–∞–π–¥ ‚Ä¢ –£–¥–µ—Ä–∂–∞–Ω–∏–µ ‚Äî –æ–≥–æ–Ω—å</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>
(function(){
  const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints>0;
  const rand=(a,b)=>a+Math.random()*(b-a);

  // ---- RENDERER ----
  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, powerPreference:'high-performance' });
  renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.55;
  document.body.prepend(renderer.domElement);

  // ---- SCENE ----
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 400);
  camera.position.set(0.2, 2.0, 6.5);

  const hemi = new THREE.HemisphereLight(0xfff3d1, 0xdbc0a0, 0.95);
  const sun  = new THREE.DirectionalLight(0xffffff, 1.45); sun.position.set(8,7,4); sun.castShadow=true; sun.shadow.mapSize.set(1024,1024);
  const rim  = new THREE.DirectionalLight(0xff9bd4, 0.9); rim.position.set(-6,3,-2);
  scene.add(hemi, sun, rim);

  // Simple candy sky & ground
  function makeSkyGradient(top='#fff8ff', mid='#f0f7ff', bot='#fff0f4'){
    const c=document.createElement('canvas'); c.width=2; c.height=256; const g=c.getContext('2d');
    const grd=g.createLinearGradient(0,0,0,256); grd.addColorStop(0,top); grd.addColorStop(.55,mid); grd.addColorStop(1,bot);
    g.fillStyle=grd; g.fillRect(0,0,2,256); return new THREE.CanvasTexture(c);
  }
  const skyTex = makeSkyGradient(); const sky = new THREE.Mesh(new THREE.SphereGeometry(180, 32, 16), new THREE.MeshBasicMaterial({ map: skyTex, side:THREE.BackSide })); scene.add(sky);
  function texGround(){ const c=document.createElement('canvas'); c.width=256; c.height=256; const g=c.getContext('2d');
    g.fillStyle='#ffe9d1'; g.fillRect(0,0,256,256);
    const colors=['#ffd1dc','#ffe8aa','#d7f1ff','#e9d4ff']; 
    for(let y=0;y<256;y+=32){ for(let x=0;x<256;x+=32){ g.fillStyle=colors[(x/32+y/32)%colors.length]; g.globalAlpha=.23; g.fillRect(x+6,y+6,20,20);} } 
    g.globalAlpha=1; return new THREE.CanvasTexture(c); }
  const gtex = texGround(); gtex.wrapS=gtex.wrapT=THREE.RepeatWrapping; gtex.repeat.set(10,100);
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(90, 800), new THREE.MeshStandardMaterial({ map:gtex, metalness:.05, roughness:.95 }));
  ground.rotation.x=-Math.PI/2; ground.position.z=-240; ground.receiveShadow=true; scene.add(ground);
  const laneLine = new THREE.Mesh(new THREE.PlaneGeometry(0.12,140), new THREE.MeshBasicMaterial({ color:0x3b6cff, transparent:true, opacity:.6 }));
  laneLine.rotation.x=-Math.PI/2; laneLine.position.z=-60; scene.add(laneLine);

  // Oreo model
  function createOreo(){
    const g1=new THREE.CylinderGeometry(.52,.52,.2,64);
    const g2=new THREE.CylinderGeometry(.49,.49,.09,48);
    const matB=new THREE.MeshStandardMaterial({ color:0x3b2f2f, metalness:.35, roughness:.55 });
    const matC=new THREE.MeshStandardMaterial({ color:0xffffff, metalness:.05, roughness:.35, emissive:0x222222, emissiveIntensity:.05 });
    const top=new THREE.Mesh(g1,matB), bot=new THREE.Mesh(g1,matB), cream=new THREE.Mesh(g2,matC);
    top.position.y=.14; bot.position.y=-.14; top.castShadow=bot.castShadow=cream.castShadow=true;
    const group=new THREE.Group(); group.add(top,bot,cream);
    const eye=new THREE.SphereGeometry(.038,16,12), eyeM=new THREE.MeshStandardMaterial({color:0x111111});
    const e1=new THREE.Mesh(eye,eyeM), e2=new THREE.Mesh(eye,eyeM); e1.position.set(-.12,.06,.49); e2.position.set(.12,.06,.49); group.add(e1,e2);
    return group;
  }
  const player=createOreo(); player.position.set(0,.68,0); scene.add(player);
  const haloTex=(()=>{ const c=document.createElement('canvas'); c.width=256; c.height=256; const g=c.getContext('2d'); const grd=g.createRadialGradient(128,128,40,128,128,128); grd.addColorStop(0,'rgba(85,221,255,.35)'); grd.addColorStop(1,'rgba(85,221,255,0)'); g.fillStyle=grd; g.fillRect(0,0,256,256); return new THREE.CanvasTexture(c); })();
  const halo=new THREE.Sprite(new THREE.SpriteMaterial({ map:haloTex, color:0x55ddff, transparent:true, opacity:0 })); halo.scale.set(2.2,2.2,1); player.add(halo); halo.position.set(0,0,.1);

  // Lanes
  const laneX=[-1.6,0,1.6]; let laneIdx=1, targetX=laneX[laneIdx];

  // Entities
  const obstacles=[], goodies=[], crumbs=[], shots=[], particles=[];

  // Obstacle models
  function mkBarrier(){ const bar=new THREE.Group();
    const base=new THREE.Mesh(new THREE.BoxGeometry(1.2,.4,.3), new THREE.MeshStandardMaterial({ color:0x3a3a4a }));
    const bar1=new THREE.Mesh(new THREE.BoxGeometry(1.2,.18,.18), new THREE.MeshStandardMaterial({ color:0xff8c63, emissive:0xff8c63, emissiveIntensity:.35 })); bar1.position.y=.25;
    const stripes=new THREE.Mesh(new THREE.BoxGeometry(1.2,.08,.19), new THREE.MeshStandardMaterial({ color:0xffffff })); stripes.position.y=.05;
    base.castShadow=bar1.castShadow=stripes.castShadow=true; bar.add(base,bar1,stripes); bar.userData.kind='barrier'; return bar; }
  function mkCone(){ const c=new THREE.Mesh(new THREE.ConeGeometry(.5,.8,24), new THREE.MeshStandardMaterial({ color:0xff7a7a, roughness:.6 }));
    const rim=new THREE.Mesh(new THREE.TorusGeometry(.36,.07,10,24), new THREE.MeshStandardMaterial({ color:0xffffff, roughness:.4 }));
    rim.rotation.x=Math.PI/2; rim.position.y=.02; c.add(rim); c.castShadow=rim.castShadow=true; c.userData.kind='cone'; return c; }
  function mkBarrel(){ const g=new THREE.CylinderGeometry(.35,.35,.8,18,1,true);
    const m=new THREE.MeshStandardMaterial({ color:0x7d4d2a, metalness:.2, roughness:.6 });
    const b=new THREE.Mesh(g,m); const band=new THREE.Mesh(new THREE.TorusGeometry(.37,.04,12,32), new THREE.MeshStandardMaterial({ color:0x333 }));
    band.rotation.x=Math.PI/2; band.position.y=0; b.add(band); b.castShadow=band.castShadow=true; b.userData.kind='barrel'; return b; }
  function mkLowGate(){ const g=new THREE.Group();
    const h=new THREE.Mesh(new THREE.BoxGeometry(1.1,.24,.5), new THREE.MeshStandardMaterial({ color:0x7ad6ff, emissive:0x7ad6ff, emissiveIntensity:.25 }));
    h.position.y=.95; const leg1=new THREE.Mesh(new THREE.BoxGeometry(.08,.9,.5), new THREE.MeshStandardMaterial({ color:0x3b6cff }));
    const leg2=leg1.clone(); leg1.position.set(-.5,.45,0); leg2.position.set(.5,.45,0); g.add(h,leg1,leg2); g.userData.kind='gate'; return g; }

  function label(text, color){
    const can=document.createElement('canvas'); const s=256; can.width=can.height=s; const c=can.getContext('2d');
    c.fillStyle='rgba(255,255,255,.98)'; round(c,16,180,s-32,56,14); c.fill();
    c.strokeStyle=color; c.lineWidth=6; round(c,16,180,s-32,56,14); c.stroke();
    c.fillStyle=color; c.font='bold 36px ui-sans-serif,system-ui'; c.textAlign='center'; c.textBaseline='middle'; c.fillText(text,s/2,s-32-28+28);
    const tex=new THREE.CanvasTexture(can); const spr=new THREE.Sprite(new THREE.SpriteMaterial({ map:tex, transparent:true }));
    spr.scale.set(2.0,1.3,1); spr.userData.dispose=()=>tex.dispose(); return spr;
  }
  function round(c,x,y,w,h,r){ c.beginPath(); c.moveTo(x+r,y); c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r); c.arcTo(x,y+h,x,y,r); c.arcTo(x,y,x+w,y,r); c.closePath(); }

  // Spawns
  function spawnObstacle(){
    const lane=Math.floor(Math.random()*3); const x=laneX[lane];
    const r=Math.random(); let mesh, lab;
    if(r<0.28){ mesh=mkBarrier(); mesh.position.set(x,.3,-70); lab=label('ERP —É–ø–∞–ª','#ffb84b'); }
    else if(r<0.52){ mesh=mkCone(); mesh.position.set(x,.4,-70); lab=label('OOS','#ff4b6e'); }
    else if(r<0.78){ mesh=mkBarrel(); mesh.position.set(x,.4,-70); mesh.userData.roll=true; lab=label('–ù–µ—Ç —Å—Ç–æ–∫–∞','#e8a36b'); }
    else { mesh=mkLowGate(); mesh.position.set(x,.0,-70); lab=label('–ù–∏–∑–∫–∏–π –±–∞—Ä—å–µ—Ä','#7ad6ff'); }
    mesh.castShadow=true; scene.add(mesh); lab.position.set(mesh.position.x, mesh.position.y+(mesh.userData.kind==='gate'?1.2:.9), mesh.position.z); scene.add(lab);
    mesh.userData.label=lab; obstacles.push(mesh);
  }
  function spawnGoodie(){
    const kind=Math.random()<.5?'discount':(Math.random()<.8?'prepack':'erid'); const lane=Math.floor(Math.random()*3); const x=laneX[lane];
    const col=kind==='discount'?0x2b7bd4:(kind==='prepack'?0x00d6ff:0x8a5bff);
    const t=new THREE.Mesh(new THREE.TorusGeometry(.26,.07,16,24), new THREE.MeshStandardMaterial({ color:col, emissive:col, emissiveIntensity:1.2 }));
    t.position.set(x, 1.0+Math.random()*.6, -68); t.castShadow=true; t.userData.type=kind;
    const lab=label(kind==='discount'?'–î–æ–ø—Å–∫–∏–¥–∫–∞':(kind==='prepack'?'–ü—Ä–µ–ø–∞–∫ (—â–∏—Ç)':'–ë–µ–∑ ERID'), '#'+col.toString(16).padStart(6,'0'));
    lab.position.set(t.position.x, t.position.y+.9, t.position.z); scene.add(t,lab); t.userData.label=lab; goodies.push(t);
  }
  function spawnCrumbs(){
    const lane=Math.floor(Math.random()*3); const x=laneX[lane]; const n=6+Math.floor(Math.random()*3);
    for(let i=0;i<n;i++){ const s=new THREE.Mesh(new THREE.SphereGeometry(.06,12,10), new THREE.MeshStandardMaterial({ color:0x6d3b2a }));
      s.position.set(x, .74+Math.sin(i/n*Math.PI)*.5, -66-i*.9); s.castShadow=true; crumbs.push(s); scene.add(s); }
  }

  // Difficulty
  const DIFF={ easy:{speed:.22,spawn:1.0,bonus:.85}, mid:{speed:.28,spawn:.85,bonus:1.0}, hard:{speed:.36,spawn:.7,bonus:1.15} };
  let diff=DIFF.mid;

  // State & HUD
  let timeLeft=30, speed=diff.speed, t=0; let score=0, best=+localStorage.getItem('mdz_best_v7')||0;
  const hud={level:qs('#levelLabel'),score:qs('#scoreLabel'),best:qs('#bestLabel'),status:qs('#statusLabel'),
    toast:qs('#toast'),count:qs('#count'),start:qs('#startBanner'),floatTxt:qs('#floatTxt'),pill:qs('#pillTip'),
    startEasy:qs('#startEasy'),startMid:qs('#startMid'),startHard:qs('#startHard'),pauseBtn:qs('#pauseBtn'),restartBtn:qs('#restartBtn')};
  const ui={ zoneL:qs('#zoneLeft'), zoneR:qs('#zoneRight'), btnLeft:qs('#btnLeft'), btnRight:qs('#btnRight'), btnJump:qs('#btnJump'), btnSlide:qs('#btnSlide'), btnShoot:qs('#btnShoot'), hint:qs('#hint') };
  function qs(s){return document.querySelector(s)}
  function showToast(s){ hud.toast.textContent=s; hud.toast.classList.add('show'); clearTimeout(showToast.t); showToast.t=setTimeout(()=>hud.toast.classList.remove('show'),2200); }
  function floatText(txt,color){ const el=hud.floatTxt; el.textContent=txt; el.style.color=color||'#fff'; el.style.opacity=1; el.style.transform='translate(-50%,-60%) scale(1)'; clearTimeout(floatText.t); setTimeout(()=>{ el.style.opacity=0; el.style.transform='translate(-50%,-85%) scale(1.1)'; },10); floatText.t=setTimeout(()=>{ el.style.opacity=0; },700); }

  // Physics
  let vy=0, groundY=.68, jumps=0, onGround=true; let coyote=0, buffer=0; const COYOTE=.18, BUFFER=.18; const G=.0175;
  let sliding=false, slideT=0;
  function wantJump(){ buffer=BUFFER; doJump(); }
  function doJump(){ if(sliding) return; if((onGround||coyote>0)&&jumps===0){ vy=.40; jumps=1; onGround=false; coyote=0; buffer=0; squash(player, .85); return; } if(!onGround&&jumps===1){ vy=.36; jumps=2; buffer=0; squash(player, .9); return; } }
  function startSlide(){ if(sliding) return; sliding=true; slideT=.7; player.scale.y=.6; player.scale.x=1.15; }
  function endSlide(){ sliding=false; player.scale.set(1,1,1); }

  // Lanes
  function moveLeft(){ laneIdx=Math.max(0,laneIdx-1); targetX=laneX[laneIdx]; wiggleCamera(-.02); }
  function moveRight(){ laneIdx=Math.min(2,laneIdx+1); targetX=laneX[laneIdx]; wiggleCamera(+.02); }

  // Shots
  function shoot(){ const s=new THREE.Mesh(new THREE.SphereGeometry(.09,16,14), new THREE.MeshStandardMaterial({ color:0x5b3a29, emissive:0x2a1208, emissiveIntensity:.7 }));
    s.position.set(player.position.x, player.position.y+.2, .2); s.userData.vz=-2.7; s.castShadow=true; shots.push(s); scene.add(s);
    spawnBurst(player.position.x, player.position.y+.2, .2, 0x5b3a29);
  }
  let fireLoop=null;
  function startFire(){ if(fireLoop) return; shoot(); fireLoop=setInterval(shoot, 180); }
  function stopFire(){ if(fireLoop){ clearInterval(fireLoop); fireLoop=null; } }

  // Juicy helpers
  function squash(obj, k){ obj.scale.set(1.05, k, 1.05); setTimeout(()=>obj.scale.set(1,1,1), 120); }
  let shakeT=0, shakeAmp=0;
  function wiggleCamera(a){ shakeAmp=Math.min(.06, Math.abs(a)); shakeT=0.18; camera.rotation.z += a; }
  function hitFlash(mesh){ const m=mesh.material; if(Array.isArray(m)) return; if(m.emissive){ const old=m.emissive.clone(); m.emissive.setHex(0xffffff); m.emissiveIntensity=1.0; setTimeout(()=>{ m.emissive.copy(old); m.emissiveIntensity=.1; },80); } }
  function spawnBurst(x,y,z, color){ const n=16; for(let i=0;i<n;i++){ const p=new THREE.Mesh(new THREE.SphereGeometry(.04, 8,6), new THREE.MeshBasicMaterial({ color })); p.position.set(x,y,z); p.userData={vx:rand(-.08,.08), vy:rand(.04,.12), vz:rand(-.08,.02), life:.6+Math.random()*.3}; particles.push(p); scene.add(p); } }

  // Timers & loop
  let spawnT=.35, goodieT=.9, crumbT=.3; let boostTimer=0, shieldTimer=0;
  let last=performance.now(), running=false, paused=false;
  function loop(){ const now=performance.now(); const dt=Math.min(.05,(now-last)/1000); last=now; if(running&&!paused) update(dt); renderer.render(scene,camera); requestAnimationFrame(loop) } loop();

  function update(dt){
    t+=dt; timeLeft-=dt; if(timeLeft<=0){ timeLeft=30; showToast('–ù–æ–≤—ã–π –∫—Ä—É–≥'); }

    ground.position.z += speed*200*dt*(boostTimer>0?1.6:1.0); laneLine.position.z += speed*200*dt*(boostTimer>0?1.6:1.0);
    if(ground.position.z>-120) ground.position.z=-240; if(laneLine.position.z>-30) laneLine.position.z=-60; gtex.offset.y -= dt*(speed*.9+(boostTimer>0?.6:0));

    spawnT-=dt; if(spawnT<=0){ spawnObstacle(); spawnT=(.7+Math.random()*.7)*diff.spawn; }
    goodieT-=dt; if(goodieT<=0){ spawnGoodie(); goodieT=(1.0+Math.random()*.8)*diff.bonus; }
    crumbT-=dt; if(crumbT<=0){ spawnCrumbs(); crumbT=.9+Math.random()*.7; }

    const packs=[obstacles,goodies,crumbs,shots,particles];
    for(const arr of packs){
      for(const m of arr){
        if(!m) continue;
        if(m.userData && m.userData.vz) m.position.z += m.userData.vz;
        m.position.z += speed*200*dt*(boostTimer>0?1.6:1.0);
        if(m.userData && m.userData.roll){ m.rotation.z += dt*3; }
        if(m.userData && m.userData.label){ m.userData.label.position.set(m.position.x, m.position.y+(m.userData.kind==='gate'?1.2:.9), m.position.z); }
        if(m.userData && m.userData.life){ m.userData.life-=dt; m.position.x+=m.userData.vx; m.position.y+=m.userData.vy; m.position.z+=m.userData.vz; m.material.opacity = Math.max(0, m.userData.life*1.2); m.material.transparent=true; }
      }
      for(let i=arr.length-1;i>=0;i--){ const m=arr[i]; if(!m) continue; if(m.position.z>7 || (m.userData && m.userData.life<=0)){ disposeWithLabel(m); arr.splice(i,1); } }
    }

    player.position.x += (targetX - player.position.x) * Math.min(1, dt*12);

    vy -= G*(1+(jumps===2?.2:0)); player.position.y += vy;
    if(player.position.y<=.68){ player.position.y=.68; if(!onGround){ onGround=true; jumps=0; } }
    else { if(onGround){ onGround=false; coyote=.18; } }
    if(coyote>0) coyote-=dt; if(buffer>0){ buffer-=dt; if(onGround) doJump(); }

    if(sliding){ slideT-=dt; if(slideT<=0) endSlide(); }

    for(let si=shots.length-1; si>=0; si--){
      const s=shots[si]; for(let oi=obstacles.length-1; oi>=0; oi--){
        const o=obstacles[oi];
        if(Math.abs(s.position.z-o.position.z)<.6 && Math.abs(s.position.x-o.position.x)<.6){
          score+=2; hitFlash(o); spawnBurst(o.position.x, o.position.y+.2, o.position.z, 0xffc07a); disposeWithLabel(o); obstacles.splice(oi,1);
          scene.remove(s); shots.splice(si,1); floatText('+2','#ffd86b'); break;
        }
      }
    }

    const p=player.position;
    for(let i=obstacles.length-1;i>=0;i--){
      const o=obstacles[i]; const nearZ=Math.abs(o.position.z-p.z)<.55; const sameX=Math.abs(o.position.x-p.x)<.65;
      if(nearZ && sameX){
        let collide=false;
        if(o.userData.kind==='gate'){ collide=!sliding; } else { collide=Math.abs(o.position.y-p.y)<.5; }
        if(collide){ if(shieldTimer>0){ shieldTimer=0; spawnBurst(o.position.x,o.position.y+.2,o.position.z,0x88e6ff); disposeWithLabel(o); obstacles.splice(i,1); showToast('–©–∏—Ç —Å–ø–∞—Å!'); }
          else { gameOver(); return; } }
      }
    }
    for(let i=goodies.length-1;i>=0;i--){
      const m=goodies[i];
      if(m.position.distanceTo(p)<.85){
        const type=m.userData.type;
        if(type==='discount'){ boostTimer=2.8; floatText('BOOST','#7ad6ff'); showToast('–î–æ–ø—Å–∫–∏–¥–∫–∞ +3% üöÄ'); }
        else if(type==='prepack'){ shieldTimer=4.0; halo.material.opacity=.95; floatText('–©–ò–¢','#88e6ff'); showToast('–ü—Ä–µ–ø–∞–∫ ‚Äî —â–∏—Ç'); }
        else { floatText('OK','#d69bff'); showToast('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ –±–µ–∑ ERID ‚ú®'); }
        spawnBurst(m.position.x,m.position.y,m.position.z, 0x7ad6ff); disposeWithLabel(m); goodies.splice(i,1);
      }
    }
    for(let i=crumbs.length-1;i>=0;i--){ const m=crumbs[i]; if(m.position.distanceTo(p)<.7){ score++; spawnBurst(m.position.x,m.position.y,m.position.z, 0x6d3b2a); scene.remove(m); crumbs.splice(i,1); floatText('+1','#fff'); } }

    if(shieldTimer>0){ halo.material.opacity=Math.min(.95,.5+Math.sin(t*8)*.35); } else { halo.material.opacity=Math.max(0,halo.material.opacity- dt*2); }
    speed = diff.speed * (boostTimer>0?1.6:1.0); if(boostTimer>0) boostTimer-=dt; if(shieldTimer>0) shieldTimer-=dt;

    hud.score.textContent='–û—á–∫–∏ (–∫—Ä–æ—à–∫–∏): '+score;
    hud.best.textContent='–†–µ–∫–æ—Ä–¥: '+Math.max(best,score);
    hud.status.textContent=`–û—Å—Ç–∞–ª–æ—Å—å: ${Math.max(0,Math.ceil(timeLeft))}—Å` + (shieldTimer>0?' ‚Ä¢ –©–∏—Ç':'') + (boostTimer>0?' ‚Ä¢ –£—Å–∫–æ—Ä–µ–Ω–∏–µ':'') + (sliding?' ‚Ä¢ –°–ª–∞–π–¥':'');
  }

  function disposeWithLabel(m){ if(m.userData && m.userData.label){ scene.remove(m.userData.label); m.userData.label.material.map && m.userData.label.material.map.dispose(); } scene.remove(m); }

  // Start/pause
  function clearAll(){ for(const a of [obstacles,goodies,crumbs,shots,particles]){ a.forEach(m=>disposeWithLabel(m)); a.length=0; } }
  function start(chosen){
    diff=DIFF[chosen]||DIFF.mid;
    hud.start.classList.add('hidden');
    ui.hint.style.display='block'; hud.pill.style.display='block';
    timeLeft=30; t=0; score=0; laneIdx=1; targetX=laneX[1];
    player.position.set(0,.68,0); vy=0; jumps=0; onGround=true; coyote=0; boostTimer=0; shieldTimer=0; endSlide();
    clearAll(); paused=false; running=false; let n=3; hud.count.textContent=n; hud.count.classList.remove('hidden');
    const tick=()=>{ n--; if(n>0){ hud.count.textContent=n; setTimeout(tick,600);} else { hud.count.classList.add('hidden'); running=true; } };
    setTimeout(tick,600);
  }
  function gameOver(){ running=false; best=Math.max(best,score); localStorage.setItem('mdz_best_v7',best); showToast('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞'); setTimeout(()=>start('mid'),1200); }

  // --- INPUT: Keyboard (fallback) ---
  function onKey(e){
    if(e.code==='ArrowLeft'||e.code==='KeyA'){ moveLeft(); }
    else if(e.code==='ArrowRight'||e.code==='KeyD'){ moveRight(); }
    else if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); wantJump(); }
    else if(e.code==='ShiftLeft'||e.code==='ShiftRight'){ shoot(); }
    else if(e.code==='ArrowDown'||e.code==='KeyS'){ startSlide(); }
    else if(e.code==='KeyP'){ paused=!paused; }
  }
  window.addEventListener('keydown', onKey);
  window.addEventListener('keyup', (e)=>{ if(e.code==='ArrowDown'||e.code==='KeyS') endSlide(); });

  // --- INPUT: Dual-zone touch scheme ---
  // Left zone: horizontal swipe = lanes
  let L_startX=0, L_active=false;
  ui.zoneL.addEventListener('touchstart', e=>{ if(e.touches.length===1){ L_active=true; L_startX=e.touches[0].clientX; } }, {passive:true});
  ui.zoneL.addEventListener('touchmove', e=>{ if(!L_active) return; const dx=e.touches[0].clientX-L_startX; if(Math.abs(dx)>48){ dx>0?moveRight():moveLeft(); L_active=false; } }, {passive:true});
  ui.zoneL.addEventListener('touchend', ()=>{ L_active=false; }, {passive:true});

  // Right zone: tap = jump, swipe down = slide, long press = auto-fire
  let R_startX=0, R_startY=0, R_active=false, R_pressTimer=null;
  function startPress(){ stopFire(); R_pressTimer=setTimeout(()=>startFire(), 260); }
  function stopPress(){ if(R_pressTimer){ clearTimeout(R_pressTimer); R_pressTimer=null; } stopFire(); }
  ui.zoneR.addEventListener('touchstart', e=>{
    if(e.touches.length===1){ R_active=true; R_startX=e.touches[0].clientX; R_startY=e.touches[0].clientY; startPress(); }
  }, {passive:true});
  ui.zoneR.addEventListener('touchmove', e=>{
    if(!R_active) return;
    const dx=e.touches[0].clientX-R_startX; const dy=e.touches[0].clientY-R_startY;
    if(Math.abs(dy)>60 && Math.abs(dy)>Math.abs(dx)){ if(dy>0){ endSlide(); startSlide(); stopPress(); R_active=false; } else { wantJump(); stopPress(); R_active=false; } }
  }, {passive:true});
  ui.zoneR.addEventListener('touchend', e=>{
    if(!R_active) return;
    stopPress();
    // If short tap without swipe -> jump (or double-jump via buffer)
    wantJump();
    R_active=false;
  }, {passive:true});

  // On-screen soft keys
  ui.btnLeft.addEventListener('click', moveLeft); ui.btnRight.addEventListener('click', moveRight);
  ui.btnJump.addEventListener('click', wantJump);
  ui.btnSlide.addEventListener('pointerdown', startSlide); ui.btnSlide.addEventListener('pointerup', endSlide); ui.btnSlide.addEventListener('touchend', endSlide, {passive:true});
  ui.btnShoot.addEventListener('pointerdown', startFire); ui.btnShoot.addEventListener('pointerup', stopFire); ui.btnShoot.addEventListener('touchend', stopFire, {passive:true});

  // Buttons (start/pause/restart)
  function bindStart(id, lvl){ const el=document.getElementById(id); ['click','pointerup','touchend'].forEach(ev=>el.addEventListener(ev, ()=>start(lvl), {passive:true})); }
  bindStart('startEasy','easy'); bindStart('startMid','mid'); bindStart('startHard','hard');
  ;['click','pointerup','touchend'].forEach(ev=>document.getElementById('pauseBtn').addEventListener(ev, ()=>{ paused=!paused; }, {passive:true}));
  ;['click','pointerup','touchend'].forEach(ev=>document.getElementById('restartBtn').addEventListener(ev, ()=>start('mid'), {passive:true}));

  window.addEventListener('resize', ()=>{ const w=innerWidth,h=innerHeight; renderer.setSize(w,h); camera.aspect=w/h; camera.updateProjectionMatrix(); });

  // HUD init
  hud.level.textContent='–£—Ä–æ–≤–µ–Ω—å: ‚Äî'; hud.score.textContent='–û—á–∫–∏ (–∫—Ä–æ—à–∫–∏): 0'; hud.best.textContent='–†–µ–∫–æ—Ä–¥: '+best;
})();</script>
</body>
</html>
