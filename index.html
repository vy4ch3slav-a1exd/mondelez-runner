<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Mondelez Runner ‚Äî 3D v3 Candy</title>
<meta name="theme-color" content="#f5f0ff">
<style>
  :root { --bg:#0a0d1a; --ui:#ffffff; --accent:#7a4bd4; --mint:#00ff95; --blue:#2b7bd4; }
  * { box-sizing: border-box; }
  html, body { margin:0; height:100%; background:#f7f2ff; overflow:hidden; }
  #hud { position:fixed; inset:0; pointer-events:none; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; }
  .hud { position:absolute; left:12px; top:10px; color:#fff; text-shadow:0 3px 12px rgba(0,0,0,.45); font-weight:800; }
  .hud .line { font-size:13px; letter-spacing:.2px; }
  .hud .big { font-size:16px; margin-bottom:2px; }
  .btns { position:absolute; right:12px; top:10px; display:flex; gap:8px; }
  .btn { pointer-events:auto; border:none; border-radius:12px; padding:10px 16px; background:#2b225a; color:#fff; font-weight:800; cursor:pointer; box-shadow:0 8px 26px rgba(0,0,0,.25); }
  .btn.sec { background:var(--blue); }
  .toast { position:absolute; left:50%; transform:translateX(-50%); bottom:9vh; background:rgba(20,20,35,.92);
           color:#d9d9ff; padding:10px 14px; border:1px solid rgba(122,75,212,.4); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); opacity:0; transition:opacity .25s, transform .25s; pointer-events:none; white-space:nowrap; }
  .toast.show { opacity:1; transform:translate(-50%, -8px); }
  .banner { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
  .card { pointer-events:auto; max-width:min(920px, 96vw); background:#fff; border:3px solid var(--accent); border-radius:20px; padding:20px 22px; color:#2b225a; text-align:center; box-shadow:0 22px 70px rgba(114,84,196,.25); }
  .hidden { display:none; }
  .dev { font-family: ui-monospace, Menlo, Consolas, monospace; color:var(--mint); text-shadow:0 0 8px rgba(0,255,149,.35); font-size:clamp(13px,2.2vw,18px); margin:6px 0 12px; }
  .start-title { font-size: clamp(24px, 4vw, 40px); margin: 6px 0 10px; }
  .mini { opacity:.85; font-size:clamp(12px,2vw,15px); }
  .start-actions { display:flex; justify-content:center; gap:14px; margin-top:14px; flex-wrap:wrap; }
  .btnlg { pointer-events:auto; border:none; border-radius:12px; padding:13px 20px; background:#2b225a; color:#fff; font-weight:900; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  .diff { background:#efe9ff; color:#2b225a; border:2px solid #7a4bd4; }
  .diff.easy { border-color:#35d69a; }
  .diff.mid  { border-color:#2b7bd4; }
  .diff.hard { border-color:#ff6b8a; }
  .countdown { position:absolute; left:50%; top:38%; transform:translate(-50%,-50%); color:#fff; font-weight:900; font-size:12vh; text-shadow:0 10px 50px rgba(0,0,0,.35); pointer-events:none; }
  .touchhint { position:absolute; left:50%; bottom:24px; transform:translateX(-50%); color:#003226; background:#bff2e8; border:2px solid #0acaa0; padding:6px 10px; border-radius:10px; font:12px/1.2 ui-monospace, Menlo, Consolas, monospace; }
</style>
</head>
<body>
<div id="hud">
  <div class="hud">
    <div class="line big" id="levelLabel">–£—Ä–æ–≤–µ–Ω—å: ‚Äî</div>
    <div class="line" id="scoreLabel">–û—á–∫–∏ (–∫—Ä–æ—à–∫–∏): 0</div>
    <div class="line" id="bestLabel">–†–µ–∫–æ—Ä–¥: 0</div>
    <div class="line" id="statusLabel"></div>
  </div>
  <div class="btns">
    <button class="btn" id="restartBtn">–ó–∞–Ω–æ–≤–æ</button>
    <button class="btn sec" id="pauseBtn">–ü–∞—É–∑–∞</button>
  </div>
  <div class="toast" id="toast">–¢–µ–∫—Å—Ç</div>
  <div class="countdown hidden" id="count">3</div>
  <div class="touchhint" id="hint">–¢–∞–ø ‚Äî –ø—Ä—ã–∂–æ–∫, –≤—Ç–æ—Ä–æ–π —Ç–∞–ø ‚Äî –¥–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫</div>

  <div class="banner" id="startBanner" aria-modal="true" role="dialog">
    <div class="card">
      <div style="font-size:46px;margin-bottom:6px;">üç™‚ú®üç´</div>
      <h1 class="start-title">Mondelez Runner ‚Äî 3D v3 Candy</h1>
      <div class="dev">Œõl—î–∫—ÅŒ±ndr R√∏d—ñonœÉv ‚Ä¢ Œõl—îx—îy Bl—ñnœÉv</div>
      <div class="mini">–í—ã–±–µ—Ä–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å. –Ø—Ä–∫–∏–µ –∫–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–∏–µ –º–∏—Ä—ã: —à–æ–∫–æ–ª–∞–¥–Ω–∞—è —Ñ–∞–±—Ä–∏–∫–∞, –ø–µ—á–µ–Ω—å–∫–æ–≤—ã–π –≥–æ—Ä–æ–¥, –º–∞—Ä–º–µ–ª–∞–¥–Ω—ã–µ –≥–æ—Ä—ã. –©–∏—Ç ¬´–ü—Ä–µ–ø–∞–∫¬ª —Å–≤–µ—Ç–∏—Ç—Å—è, –ª–µ–π–±–ª—ã —É –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤. –î–≤–æ–π–Ω–æ–π –ø—Ä—ã–∂–æ–∫ –ø—Ä–æ—â–∞—é—â–∏–π.</div>
      <div class="start-actions">
        <button class="btnlg diff easy"  id="startEasy">ü•ß –õ–ï–ì–ö–û</button>
        <button class="btnlg diff mid"   id="startMid">üç´ –°–†–ï–î–ù–ï</button>
        <button class="btnlg diff hard"  id="startHard">‚ö° –°–õ–û–ñ–ù–û</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>
(function(){
  const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints>0;

  // Renderer
  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, powerPreference:'high-performance' });
  renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.45;
  document.body.prepend(renderer.domElement);

  // Scene & camera
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 280);
  camera.position.set(0.2, 2.0, 6.5);

  // Lights
  const hemi = new THREE.HemisphereLight(0xfff3d1, 0xffccaa, 0.8);
  const sun  = new THREE.DirectionalLight(0xffffff, 1.35); sun.position.set(6,7,4); sun.castShadow=true; sun.shadow.mapSize.set(1024,1024);
  const rim  = new THREE.DirectionalLight(0xffb6e6, 0.65); rim.position.set(-5,3,-2);
  scene.add(hemi, sun, rim);

  // THEMES (procedural textures)
  function texWaffle(col1='#f8e7c6', col2='#e7cd9f'){
    const c=document.createElement('canvas'); c.width=256; c.height=256; const g=c.getContext('2d');
    g.fillStyle=col1; g.fillRect(0,0,256,256); g.fillStyle=col2;
    for(let y=0;y<256;y+=32){ for(let x=0;x<256;x+=32){ g.fillRect(x+6,y+6,20,20); } }
    return new THREE.CanvasTexture(c);
  }
  function texStripes(colA='#ffd6e9', colB='#e6f2ff'){
    const c=document.createElement('canvas'); c.width=256; c.height=256; const g=c.getContext('2d');
    for(let y=0;y<256;y++){ g.fillStyle=(y%16<8)?colA:colB; g.fillRect(0,y,256,1); }
    return new THREE.CanvasTexture(c);
  }
  function texDots(base='#fff0f7', dot='#ffc7df'){
    const c=document.createElement('canvas'); c.width=256; c.height=256; const g=c.getContext('2d');
    g.fillStyle=base; g.fillRect(0,0,256,256); g.fillStyle=dot;
    for(let y=0;y<256;y+=32){ for(let x=0;x<256;x+=32){ g.beginPath(); g.arc(x+16,y+16,5,0,Math.PI*2); g.fill(); } }
    return new THREE.CanvasTexture(c);
  }

  // Background candy world
  const bgGroup = new THREE.Group(); scene.add(bgGroup);
  function buildCandyWorld(theme){
    // cleanup
    while(bgGroup.children.length){ const m=bgGroup.children.pop(); m.material.map?.dispose?.(); m.material?.dispose?.(); m.geometry?.dispose?.(); }
    // sky
    const sky = new THREE.Mesh(new THREE.SphereGeometry(120,32,16), new THREE.MeshBasicMaterial({ color: theme.sky || 0xfff7ff, side:THREE.BackSide }));
    bgGroup.add(sky);
    // hills/ground
    const groundTex = theme.groundTex();
    groundTex.wrapS = groundTex.wrapT = THREE.RepeatWrapping; groundTex.repeat.set(8,40);
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(80, 400), new THREE.MeshStandardMaterial({ map: groundTex, metalness:.1, roughness:.9 }));
    ground.rotation.x = -Math.PI/2; ground.position.z = -120; ground.receiveShadow=true; bgGroup.add(ground);
    // candy mountains
    for(let i=0;i<8;i++){
      const r = 2+Math.random()*2.2, h= 2.5+Math.random()*2.5;
      const m = new THREE.Mesh(new THREE.ConeGeometry(r,h, 24), new THREE.MeshStandardMaterial({ color: theme.candy || 0xff87b7, roughness:.7, metalness:.0 }));
      m.position.set((Math.random()*2-1)*24, h/2-0.2, -40 - Math.random()*80);
      m.castShadow=true; bgGroup.add(m);
    }
    // marshmallow clouds
    for(let i=0;i<10;i++){
      const s= 1.6+Math.random()*2;
      const cloud = new THREE.Mesh(new THREE.SphereGeometry(s, 18, 14), new THREE.MeshStandardMaterial({ color: 0xffffff, roughness:.6 }));
      cloud.position.set((Math.random()*2-1)*20, 6+Math.random()*4, -30 - Math.random()*80);
      cloud.castShadow=false; bgGroup.add(cloud);
    }
    return {groundTex, ground};
  }

  const THEMES=[
    { name:'–®–æ–∫–æ–ª–∞–¥–Ω–∞—è —Ñ–∞–±—Ä–∏–∫–∞', sky:0xfffbf2, groundTex:()=>texWaffle('#f7e4c3','#e8cfa5'), candy:0x9c5b3b },
    { name:'–ü–µ—á–µ–Ω—å–∫–æ–≤—ã–π –≥–æ—Ä–æ–¥', sky:0xf6fbff, groundTex:()=>texDots('#fff7fb','#ffd6eb'), candy:0xff9ed1 },
    { name:'–ú–∞—Ä–º–µ–ª–∞–¥–Ω—ã–µ –≥–æ—Ä—ã', sky:0xf4fff8, groundTex:()=>texStripes('#d8fff0','#e8f3ff'), candy:0x8ee8c0 },
  ];
  let themeIdx=0; let themeAssets=buildCandyWorld(THEMES[themeIdx]);
  function cycleTheme(){ themeIdx=(themeIdx+1)%THEMES.length; themeAssets=buildCandyWorld(THEMES[themeIdx]); showToast('–¢–µ–º–∞: '+THEMES[themeIdx].name); }

  // Grid lane line (center) for distance cue
  const lane = new THREE.Mesh(new THREE.PlaneGeometry(0.12, 120), new THREE.MeshBasicMaterial({ color:0x3355aa, transparent:true, opacity:.55 }));
  lane.rotation.x=-Math.PI/2; lane.position.z=-40; scene.add(lane);

  // Labels
  function makeLabelSprite(text, color){
    const can = document.createElement('canvas'); const s=256; can.width=can.height=s; const c=can.getContext('2d');
    c.fillStyle='rgba(255,255,255,.98)'; round(c, 16, 180, s-32, 56, 14); c.fill();
    c.strokeStyle=color; c.lineWidth=6; round(c, 16, 180, s-32, 56, 14); c.stroke();
    c.fillStyle=color; c.font='bold 36px ui-sans-serif, system-ui'; c.textAlign='center'; c.textBaseline='middle';
    c.fillText(text, s/2, s-32-28+28);
    const tex=new THREE.CanvasTexture(can);
    const spr=new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, depthTest:true, transparent:true }));
    spr.scale.set(1.9,1.25,1); spr.userData.dispose=()=>tex.dispose(); return spr;
  }
  function round(c,x,y,w,h,r){ c.beginPath(); c.moveTo(x+r,y); c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r); c.arcTo(x,y+h,x,y,r); c.arcTo(x,y,x+w,y,r); c.closePath(); }

  // Oreo
  function createOreo(){
    const g1 = new THREE.CylinderGeometry(0.52,0.52,0.2, 64);
    const g2 = new THREE.CylinderGeometry(0.49,0.49,0.09, 48);
    const matBrown = new THREE.MeshStandardMaterial({ color: 0x3b2f2f, metalness:0.35, roughness:0.55 });
    const matCream = new THREE.MeshStandardMaterial({ color: 0xffffff, metalness:0.05, roughness:0.35, emissive:0x222222, emissiveIntensity:0.05 });
    const top = new THREE.Mesh(g1, matBrown), bot = new THREE.Mesh(g1, matBrown), cream = new THREE.Mesh(g2, matCream);
    top.castShadow=bot.castShadow=cream.castShadow=true; top.position.y=0.14; bot.position.y=-0.14;
    const group = new THREE.Group(); group.add(top,bot,cream);
    const eyeGeo=new THREE.SphereGeometry(0.038,16,12), eyeMat=new THREE.MeshStandardMaterial({color:0x111111});
    const e1=new THREE.Mesh(eyeGeo,eyeMat), e2=new THREE.Mesh(eyeGeo,eyeMat); e1.position.set(-0.12,0.06,0.49); e2.position.set(0.12,0.06,0.49); group.add(e1,e2);
    return group;
  }
  const player = createOreo(); player.position.set(0,0.68,0); scene.add(player);
  const haloTex = new THREE.CanvasTexture(makeHaloTexture());
  const halo = new THREE.Sprite(new THREE.SpriteMaterial({ map: haloTex, color: 0x55ddff, transparent:true, opacity:0 }));
  halo.scale.set(2.2,2.2,1); player.add(halo); halo.position.set(0,0,0.1);

  // Entities
  const obstacles=[], goodies=[], crumbs=[];
  function spawnObstacle(){
    const type = Math.random()<0.5? 'cube' : (Math.random()<0.5?'fall':'wall');
    let mesh, label;
    if(type==='cube'){
      const s=0.55+Math.random()*0.35;
      mesh=new THREE.Mesh(new THREE.BoxGeometry(s,s,s), new THREE.MeshStandardMaterial({ color:0xff4b6e }));
      mesh.position.set((Math.random()*2-1)*1.6, 0.28, -60);
      label=makeLabelSprite('OOS','#ff4b6e');
    }else if(type==='fall'){
      const s=0.5+Math.random()*0.35;
      mesh=new THREE.Mesh(new THREE.BoxGeometry(s,s,s), new THREE.MeshStandardMaterial({ color:0xe8a36b }));
      mesh.userData.fall=true; mesh.userData.vy=0.03+Math.random()*0.02;
      mesh.position.set((Math.random()*2-1)*1.6, 3+Math.random()*1.5, -60);
      label=makeLabelSprite('–ù–µ—Ç —Å—Ç–æ–∫–∞','#e8a36b');
    }else{
      const w=0.9+Math.random()*0.5, h=0.38+Math.random()*0.2;
      mesh=new THREE.Mesh(new THREE.BoxGeometry(w,h,0.6), new THREE.MeshStandardMaterial({ color:0xffb84b }));
      mesh.position.set((Math.random()*2-1)*1.6, h/2, -60);
      label=makeLabelSprite('ERP —É–ø–∞–ª','#ffb84b');
    }
    mesh.castShadow=true; scene.add(mesh);
    label.position.set(mesh.position.x, mesh.position.y+0.8, mesh.position.z); scene.add(label);
    mesh.userData.label=label; obstacles.push(mesh);
  }
  function spawnGoodie(){
    const r=Math.random(); const type=r<.5?'discount':(r<.8?'prepack':'erid');
    const color = type==='discount'?0x2b7bd4:(type==='prepack'?0x00d6ff:0x7a4bd4);
    const t=new THREE.Mesh(new THREE.TorusGeometry(0.26,0.07,16,24), new THREE.MeshStandardMaterial({ color, emissive: color, emissiveIntensity:1.2 }));
    t.position.set((Math.random()*2-1)*1.6, 1.0+Math.random()*0.8, -58); t.castShadow=true; t.userData.type=type;
    const label=makeLabelSprite(type==='discount'?'–î–æ–ø—Å–∫–∏–¥–∫–∞':(type==='prepack'?'–ü—Ä–µ–ø–∞–∫ (—â–∏—Ç)':'–ë–µ–∑ ERID'), '#'+color.toString(16).padStart(6,'0'));
    label.position.set(t.position.x, t.position.y+0.9, t.position.z); scene.add(t,label); t.userData.label=label; goodies.push(t);
  }
  function spawnCrumbs(){
    const n = 6 + Math.floor(Math.random()*4);
    for(let i=0;i<n;i++){
      const s=new THREE.Mesh(new THREE.SphereGeometry(0.06,12,10), new THREE.MeshStandardMaterial({ color:0x6d3b2a }));
      s.position.set((Math.random()*2-1)*1.6, 0.74+Math.sin(i/n*Math.PI)*0.5, -56-i*0.9);
      s.castShadow=true; crumbs.push(s); scene.add(s);
    }
  }

  // DIFFICULTY
  const DIFF={
    easy : { speed:0.22, spawn:1.0, bonus:0.85 },
    mid  : { speed:0.28, spawn:0.9,  bonus:1.0  },
    hard : { speed:0.33, spawn:0.75, bonus:1.2  }
  };
  let diff=DIFF.mid;

  // Game state
  const levels=[
    { name:'–°–∫–ª–∞–¥ –†–¶', seconds:24 },
    { name:'–ú–∞–≥–∞–∑–∏–Ω', seconds:28 },
    { name:'–ü–µ—Ä–µ–≥–æ–≤–æ—Ä–∫–∞', seconds:32 }
  ];
  let levelIdx=0, timeLeft=levels[0].seconds, speed=diff.speed, t=0;
  let score=0, best=+localStorage.getItem('mdz_best_candy3d')||0;

  // HUD
  const hud={
    level:document.getElementById('levelLabel'),
    score:document.getElementById('scoreLabel'),
    best:document.getElementById('bestLabel'),
    status:document.getElementById('statusLabel'),
    toast:document.getElementById('toast'),
    count:document.getElementById('count'),
    start:document.getElementById('startBanner'),
    startEasy:document.getElementById('startEasy'),
    startMid:document.getElementById('startMid'),
    startHard:document.getElementById('startHard'),
    pauseBtn:document.getElementById('pauseBtn'),
    restartBtn:document.getElementById('restartBtn'),
    hint:document.getElementById('hint')
  };
  function showToast(s){ hud.toast.textContent=s; hud.toast.classList.add('show'); clearTimeout(showToast.t); showToast.t=setTimeout(()=>hud.toast.classList.remove('show'),2000); }

  // Physics & jump
  let vy=0, groundY=0.68, jumps=0, onGround=true;
  let coyote=0, buffer=0; const COYOTE=0.18, BUFFER=0.18; const G=0.0175;
  function wantJump(){ buffer=BUFFER; doJump(); }
  function doJump(){
    if((onGround||coyote>0)&&jumps===0){ vy=0.40; jumps=1; onGround=false; coyote=0; buffer=0; return; }
    if(!onGround&&jumps===1){ vy=0.36; jumps=2; buffer=0; return; }
  }

  // Timers
  let spawnT=0.4, goodieT=0.9, crumbT=0.25;
  // Boosters
  let boostTimer=0, shieldTimer=0;

  // Loop
  let last=performance.now(), running=false, paused=false;
  function loop(){ const now=performance.now(); const dt=Math.min(0.05,(now-last)/1000); last=now; if(running&&!paused) update(dt); renderer.render(scene, camera); requestAnimationFrame(loop) } loop();

  function update(dt){
    t+=dt; timeLeft-=dt; if(timeLeft<=0){ levelIdx=(levelIdx+1)%levels.length; timeLeft=levels[levelIdx].seconds; cycleTheme(); hud.level.textContent='–£—Ä–æ–≤–µ–Ω—å: '+levels[levelIdx].name; }
    // move background
    themeAssets.ground.position.z += speed*160*dt*(boostTimer>0?1.6:1.0); lane.position.z += speed*160*dt*(boostTimer>0?1.6:1.0);
    if(themeAssets.ground.position.z>-40) themeAssets.ground.position.z=-120;
    if(lane.position.z>-20) lane.position.z=-40;
    themeAssets.groundTex.offset.y -= dt*(speed*0.8+(boostTimer>0?0.6:0));

    // spawns with difficulty multipliers
    spawnT-=dt; if(spawnT<=0){ spawnObstacle(); spawnT = (0.7+Math.random()*0.8) * diff.spawn; }
    goodieT-=dt; if(goodieT<=0){ spawnGoodie(); goodieT = (1.0+Math.random()*0.8) * diff.bonus; }
    crumbT-=dt; if(crumbT<=0){ spawnCrumbs(); crumbT=0.9+Math.random()*0.7; }

    // world forward
    const packs=[obstacles, goodies, crumbs];
    for(const arr of packs){
      for(const m of arr){
        m.position.z += speed*160*dt*(boostTimer>0?1.6:1.0);
        if(m.userData.fall){ m.position.y=Math.max(0.28, m.position.y-(m.userData.vy||0.03)); }
        if(m.userData.label){ m.userData.label.position.set(m.position.x, m.position.y+0.9, m.position.z); }
      }
      for(let i=arr.length-1;i>=0;i--){ if(arr[i].position.z>6){ if(arr[i].userData.label){ scene.remove(arr[i].userData.label); arr[i].userData.label.material.map.dispose?.(); } scene.remove(arr[i]); arr.splice(i,1); } }
    }

    // physics
    vy -= G*(1+(jumps===2?0.2:0)); player.position.y += vy;
    if(player.position.y<=groundY){ player.position.y=groundY; if(!onGround){ onGround=true; jumps=0; } }
    else { if(onGround){ onGround=false; coyote=COYOTE; } }
    if(coyote>0) coyote-=dt;
    if(buffer>0){ buffer-=dt; if(onGround) doJump(); }

    // collisions
    const p=player.position;
    for(let i=obstacles.length-1;i>=0;i--){
      const m=obstacles[i];
      if(Math.abs(m.position.z-p.z)<0.55 && Math.abs(m.position.x-p.x)<0.65 && Math.abs(m.position.y-p.y)<0.5){
        if(shieldTimer>0){ shieldTimer=0; removeLabel(m); obstacles.splice(i,1); showToast('–©–∏—Ç —Å–ø–∞—Å!'); }
        else { gameOver(); return; }
      }
    }
    for(let i=goodies.length-1;i>=0;i--){
      const m=goodies[i];
      if(m.position.distanceTo(p)<0.8){
        const type=m.userData.type;
        if(type==='discount'){ boostTimer=2.8; showToast('–î–æ–ø—Å–∫–∏–¥–∫–∞ +3% üöÄ'); }
        else if(type==='prepack'){ shieldTimer=4.0; halo.material.opacity=0.95; showToast('–ü—Ä–µ–ø–∞–∫ ‚Äî —â–∏—Ç'); }
        else { showToast('–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ –±–µ–∑ ERID ‚ú®'); }
        removeLabel(m); goodies.splice(i,1);
      }
    }
    for(let i=crumbs.length-1;i>=0;i--){ const m=crumbs[i]; if(m.position.distanceTo(p)<0.7){ score++; scene.remove(m); crumbs.splice(i,1); } }

    if(shieldTimer>0){ halo.material.opacity = Math.min(0.95, 0.5 + Math.sin(t*8)*0.35); } else { halo.material.opacity = Math.max(0, halo.material.opacity - dt*2); }
    speed = diff.speed * (boostTimer>0?1.6:1.0);
    if(boostTimer>0) boostTimer-=dt; if(shieldTimer>0) shieldTimer-=dt;

    player.rotation.y = Math.sin(t*0.9)*0.08;

    hud.score.textContent='–û—á–∫–∏ (–∫—Ä–æ—à–∫–∏): '+score;
    hud.best.textContent='–†–µ–∫–æ—Ä–¥: '+Math.max(best,score);
    hud.status.textContent=`–û—Å—Ç–∞–ª–æ—Å—å: ${Math.max(0,Math.ceil(timeLeft))}—Å` + (shieldTimer>0?' ‚Ä¢ –©–∏—Ç':'') + (boostTimer>0?' ‚Ä¢ –£—Å–∫–æ—Ä–µ–Ω–∏–µ':'');
  }

  function removeLabel(m){ if(m.userData.label){ scene.remove(m.userData.label); m.userData.label.material.map.dispose?.(); } scene.remove(m); }

  // Start/pause
  function startGame(chosen){
    diff = DIFF[chosen] || DIFF.mid;
    hud.start.classList.add('hidden'); document.getElementById('hint').style.display = isTouch ? 'block':'none';
    levelIdx=0; timeLeft=levels[0].seconds; t=0; score=0;
    for(const a of [obstacles, goodies, crumbs]){ a.forEach(m=>removeLabel(m)); a.length=0; }
    player.position.set(0,0.68,0); vy=0; jumps=0; onGround=true; coyote=0; boostTimer=0; shieldTimer=0;
    paused=false; running=false;
    hud.level.textContent='–£—Ä–æ–≤–µ–Ω—å: '+levels[0].name+' ‚Ä¢ '+(chosen==='easy'?'–õ–ï–ì–ö–û':chosen==='hard'?'–°–õ–û–ñ–ù–û':'–°–†–ï–î–ù–ï');
    let n=3; hud.count.textContent=n; hud.count.classList.remove('hidden');
    const tick=()=>{ n--; if(n>0){ hud.count.textContent=n; setTimeout(tick,600);} else { hud.count.classList.add('hidden'); running=true; } };
    setTimeout(tick,600);
  }

  function gameOver(){ running=false; best=Math.max(best,score); localStorage.setItem('mdz_best_candy3d',best); showToast('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞'); setTimeout(()=>startGame('mid'),1200); }

  function onJump(){ wantJump(); }
  window.addEventListener('keydown', e=>{ if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); onJump(); } if(e.code==='KeyP'){ paused=!paused; }});
  renderer.domElement.addEventListener('pointerdown', onJump, {passive:true});
  if(isTouch){ renderer.domElement.addEventListener('touchstart', onJump, {passive:true}); }

  hud.startEasy.addEventListener('click', ()=>startGame('easy'));
  hud.startMid .addEventListener('click', ()=>startGame('mid'));
  hud.startHard.addEventListener('click', ()=>startGame('hard'));
  hud.pauseBtn.addEventListener('click', ()=>{ paused=!paused; });
  hud.restartBtn.addEventListener('click', ()=>startGame('mid'));

  // Resize
  window.addEventListener('resize', ()=>{ const w=innerWidth, h=innerHeight; renderer.setSize(w,h); camera.aspect=w/h; camera.updateProjectionMatrix(); });

  // Utils
  function makeHaloTexture(){ const c=document.createElement('canvas'); c.width=256; c.height=256; const g=c.getContext('2d');
    const grad=g.createRadialGradient(128,128,40,128,128,128); grad.addColorStop(0,'rgba(85,221,255,.35)'); grad.addColorStop(1,'rgba(85,221,255,0)'); g.fillStyle=grad; g.fillRect(0,0,256,256); return c; }

  // Init HUD
  hud.level.textContent='–£—Ä–æ–≤–µ–Ω—å: ‚Äî'; hud.score.textContent='–û—á–∫–∏ (–∫—Ä–æ—à–∫–∏): 0'; hud.best.textContent='–†–µ–∫–æ—Ä–¥: '+best; hud.status.textContent='';
})();</script>
</body>
</html>
