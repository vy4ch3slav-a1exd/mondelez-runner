<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Mondelez Runner ‚Äî 3D v12 POLISH</title>
<meta name="theme-color" content="#fff4fb">
<style>
  :root{--accent:#7a61ff;--ui:#231b52;--bg:#fff4fb;--mint:#00e6a3;--blue:#2b7bd4;--rose:#ff6b8a}
  html,body{margin:0;height:100%;background:var(--bg);overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  button{touch-action:manipulation;user-select:none;font-weight:800}
  /* Canvas */
  #view{position:fixed;inset:0;z-index:0;will-change:filter}
  /* HUD */
  #hud{position:fixed;inset:0;pointer-events:none;z-index:6}
  .hudblk{position:absolute;left:calc(12px + env(safe-area-inset-left));top:calc(10px + env(safe-area-inset-top));color:#fff;
    text-shadow:0 3px 12px rgba(0,0,0,.45);font-weight:900}
  .line{font-size:13px} .big{font-size:16px;margin-bottom:2px}
  .btns{position:absolute;right:calc(12px + env(safe-area-inset-right));top:calc(10px + env(safe-area-inset-top));display:flex;gap:8px}
  .btn{pointer-events:auto;border:none;border-radius:12px;padding:10px 16px;background:var(--ui);color:#fff;box-shadow:0 8px 26px rgba(0,0,0,.25)}
  .btn.sec{background:var(--blue)}
  .btn.mute{background:#444}
  .toast{position:absolute;left:50%;transform:translateX(-50%);bottom:calc(12vh + env(safe-area-inset-bottom));background:rgba(20,20,35,.92);color:#e7e7ff;padding:10px 14px;border:1px solid rgba(122,75,212,.4);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);opacity:0;transition:opacity .25s,transform .25s;pointer-events:none;white-space:nowrap}
  .toast.show{opacity:1;transform:translate(-50%,-8px)}
  .count{position:absolute;left:50%;top:38%;transform:translate(-50%,-50%);color:#fff;font-weight:900;font-size:12vh;text-shadow:0 10px 50px rgba(0,0,0,.35);pointer-events:none}
  .plus{position:absolute;color:#fff;font-weight:900;text-shadow:0 3px 10px rgba(0,0,0,.35);opacity:0;pointer-events:none}
  .combo{position:absolute;left:50%;top:calc(12vh + env(safe-area-inset-top));transform:translateX(-50%);display:flex;align-items:center;gap:8px;
         background:rgba(255,255,255,.9);border:2px solid #c9b7ff;border-radius:14px;padding:6px 10px;color:#2b225a;font:13px/1 ui-monospace,Menlo,Consolas}
  .bar{width:120px;height:8px;border:1px solid #9f8aff;border-radius:999px;overflow:hidden}
  .fill{height:100%;width:0;background:linear-gradient(90deg,#8be0ff,#ff9bd4)}
  .flash{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;transition:opacity .08s;z-index:5}
  /* Start overlay */
  #mask{position:fixed;inset:0;background:linear-gradient(180deg,rgba(10,6,35,.55),rgba(10,6,35,.35));backdrop-filter:saturate(1.1) blur(2px);pointer-events:auto;z-index:20}
  #banner{position:fixed;left:50%;top:52%;transform:translate(-50%,-50%);z-index:21;pointer-events:auto}
  .card{max-width:min(920px,94vw);background:#fff;border:3px solid var(--accent);border-radius:20px;padding:22px;color:#241b52;text-align:center;box-shadow:0 24px 80px rgba(114,84,196,.26)}
  .title{font-size:clamp(24px,4vw,40px);margin:8px 0 12px}
  .dev{font-family:ui-monospace,Menlo,Consolas,monospace;color:var(--mint);text-shadow:0 0 8px rgba(0,255,149,.35);font-size:clamp(13px,2.2vw,18px);margin:6px 0 12px}
  .mini{opacity:.9;font-size:clamp(12px,2vw,15px)}
  .row{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-top:14px}
  .btnlg{border:none;border-radius:12px;padding:14px 20px;background:var(--ui);color:#fff}
  .diff{background:#efe9ff;color:#241b52;border:2px solid var(--accent)}
  .diff.easy{border-color:var(--mint)}.diff.mid{border-color:var(--blue)}.diff.hard{border-color:var(--rose)}
  /* Controls */
  #controls{position:fixed;inset:0;pointer-events:none;z-index:30}
  #controls.enabled{pointer-events:auto}
  .zone{position:absolute;top:0;bottom:0;width:50%}
  .zone.left{left:0}.zone.right{right:0}
  .softrow{position:absolute;left:calc(16px + env(safe-area-inset-left));bottom:calc(25vh + env(safe-area-inset-bottom));display:flex;gap:10px}
  .softkey{background:rgba(20,20,35,.7);color:#fff;border:2px solid rgba(255,255,255,.7);padding:12px 14px;border-radius:14px;pointer-events:auto;backdrop-filter:blur(6px)}
  .softbtn{position:absolute;right:calc(16px + env(safe-area-inset-right));bottom:calc(25vh + env(safe-area-inset-bottom));display:flex;gap:10px}
  .softbtn .softkey{min-width:64px;text-align:center}
  .hint{position:absolute;left:50%;bottom:calc(22vh + env(safe-area-inset-bottom));transform:translateX(-50%);background:#bff2e8;border:2px solid #0acaa0;color:#003226;padding:6px 10px;border-radius:10px;font:12px/1.2 ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
<canvas id="view"></canvas>
<div class="flash" id="flash"></div>

<div id="hud" aria-hidden="true">
  <div class="hudblk">
    <div class="line big" id="levelLabel">–£—Ä–æ–≤–µ–Ω—å: ‚Äî</div>
    <div class="line" id="scoreLabel">–û—á–∫–∏ (–∫—Ä–æ—à–∫–∏): 0</div>
    <div class="line" id="bestLabel">–†–µ–∫–æ—Ä–¥: 0</div>
    <div class="line" id="statusLabel"></div>
  </div>
  <div class="btns">
    <button class="btn mute" data-action="mute">–ó–≤—É–∫: –í–∫–ª</button>
    <button class="btn" data-action="restart">–ó–∞–Ω–æ–≤–æ</button>
    <button class="btn sec" data-action="pause">–ü–∞—É–∑–∞</button>
  </div>
  <div class="combo"><span>COMBO</span><div class="bar"><div class="fill" id="combofill"></div></div><b id="comboX">x1</b></div>
  <div class="toast" id="toast">OK</div>
  <div class="count hidden" id="count">3</div>
  <div class="plus" id="plus">+1</div>
</div>

<div id="mask"></div>
<div id="banner">
  <div class="card">
    <div style="font-size:46px;margin-bottom:6px;">üç™üéÆüç≠</div>
    <div class="title">Mondelez Runner ‚Äî 3D v12 POLISH</div>
    <div class="dev">Œõl—î–∫—ÅŒ±ndr R√∏d—ñonœÉv ‚Ä¢ Œõl—îx—îy Bl—ñnœÉv</div>
    <div class="mini">–ö–∞–º–µ—Ä–∞-–∫–∏–Ω–æ, juicy —Ñ–∏–¥–±–µ–∫, —â–∏—Ç/–º–∞–≥–Ω–∏—Ç/—É—Å–∫–æ—Ä–µ–Ω–∏–µ, –∫–æ–º–±–æ, –∞–≤—Ç–æ‚Äë—Ä–µ—Å—Ç–∞—Ä—Ç, —Ñ–∏–∫—Å SLIDE. –ù–∞–¥—ë–∂–Ω—ã–π —Å—Ç–∞—Ä—Ç –≤ iOS WebView.</div>
    <div class="row">
      <button class="btnlg diff easy" data-action="start-easy">ü•ß –õ–ï–ì–ö–û</button>
      <button class="btnlg diff mid"  data-action="start-mid">üç´ –°–†–ï–î–ù–ï</button>
      <button class="btnlg diff hard" data-action="start-hard">‚ö° –°–õ–û–ñ–ù–û</button>
    </div>
  </div>
</div>

<div id="controls">
  <div class="zone left"  data-zone="left"></div>
  <div class="zone right" data-zone="right"></div>
  <div class="softrow">
    <div class="softkey" data-action="lane-left">‚óÄÔ∏é</div>
    <div class="softkey" data-action="lane-right">‚ñ∂Ô∏é</div>
  </div>
  <div class="softbtn">
    <div class="softkey" data-action="slide">SLIDE</div>
    <div class="softkey" data-action="jump">JUMP</div>
    <div class="softkey" data-action="shoot">üéØ</div>
  </div>
  <div class="hint" id="hint">–°–≤–∞–π–ø—ã —Å–ª–µ–≤–∞ ‚Äî –ø–æ–ª–æ—Å—ã ‚Ä¢ –°–ø—Ä–∞–≤–∞: –≤–≤–µ—Ä—Ö ‚Äî –ø—Ä—ã–∂–æ–∫, –≤–Ω–∏–∑ ‚Äî —Å–ª–∞–π–¥, —É–¥–µ—Ä–∂–∞–Ω–∏–µ üéØ ‚Äî –∞–≤—Ç–æ–æ–≥–æ–Ω—å</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>
(() => {
  // ---------- Helpers ----------
  const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints>0;
  const view = document.getElementById('view');
  const flash = document.getElementById('flash');
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const lerp=(a,b,t)=>a+(b-a)*t;
  function qs(s){return document.querySelector(s)}

  // ---------- Audio ----------
  let actx=null, muted=false;
  function ensureAudio(){ try{ actx = actx || new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} }
  function beep(freq=880, dur=0.12, vol=0.2){
    if(muted) return; try{ ensureAudio(); const o=actx.createOscillator(), g=actx.createGain();
      o.frequency.value=freq; g.gain.value=vol; g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime+dur);
      o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime+dur); }catch(e){} }
  function crunch(){ if(muted) return; try{ ensureAudio(); const dur=0.12; const b=actx.createBuffer(1, actx.sampleRate*dur, actx.sampleRate); const d=b.getChannelData(0);
      for(let i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,2); } const src=actx.createBufferSource(); src.buffer=b;
      const g=actx.createGain(); g.gain.value=0.25; src.connect(g); g.connect(actx.destination); src.start(); }catch(e){} }

  // ---------- Three.js ----------
  const renderer = new THREE.WebGLRenderer({ canvas:view, antialias:true, alpha:false, powerPreference:'high-performance' });
  renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
  renderer.setSize(innerWidth, innerHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.65;

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 600);
  camera.position.set(0.0, 2.0, 7.0);

  // Lights
  const hemi = new THREE.HemisphereLight(0xfffbe5, 0xf0d7c4, 0.95);
  const sun  = new THREE.DirectionalLight(0xffffff, 1.45); sun.position.set(8,7,4); sun.castShadow=true;
  const rim  = new THREE.DirectionalLight(0xff9bd4, 0.7); rim.position.set(-6,3,-2);
  scene.add(hemi, sun, rim);

  // Sky & ground
  function gradTex(c0,c1,c2){ const c=document.createElement('canvas'); c.width=2; c.height=256;
    const g=c.getContext('2d'); const grd=g.createLinearGradient(0,0,0,256);
    grd.addColorStop(0,c0); grd.addColorStop(.6,c1); grd.addColorStop(1,c2); g.fillStyle=grd; g.fillRect(0,0,2,256); return new THREE.CanvasTexture(c); }
  const skyTex = gradTex('#fff8ff','#f5fbff','#fff0f6');
  const sky = new THREE.Mesh(new THREE.SphereGeometry(220, 32, 16), new THREE.MeshBasicMaterial({ map: skyTex, side:THREE.BackSide })); scene.add(sky);

  const gcan=document.createElement('canvas'); gcan.width=gcan.height=256; const gc=gcan.getContext('2d');
  gc.fillStyle='#ffe8d9'; gc.fillRect(0,0,256,256); gc.globalAlpha=.28;
  for(let y=0;y<256;y+=32){ for(let x=0;x<256;x+=32){ gc.fillStyle=['#ffd1dc','#ffe8aa','#d7f1ff','#e9d4ff'][(x/32+y/32)%4]; gc.fillRect(x+6,y+6,20,20);} }
  const gtex=new THREE.CanvasTexture(gcan); gtex.wrapS=gtex.wrapT=THREE.RepeatWrapping; gtex.repeat.set(8,220);
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(90, 2200), new THREE.MeshStandardMaterial({ map:gtex, metalness:.05, roughness:.96 }));
  ground.rotation.x=-Math.PI/2; ground.position.z=-560; ground.receiveShadow=true; scene.add(ground);

  // Deco
  function addCandy(x,z,col){ const pole=new THREE.Mesh(new THREE.CylinderGeometry(.08,.08,1.6,24), new THREE.MeshStandardMaterial({color:0xffffff, metalness:.1, roughness:.6}));
    const head=new THREE.Mesh(new THREE.SphereGeometry(.5,24,18), new THREE.MeshStandardMaterial({color:col, roughness:.45, metalness:.15}));
    pole.position.set(x,.8,z); head.position.set(x,1.35,z);
    const g=new THREE.Group(); g.add(pole,head); scene.add(g); return g; }
  const cols=[0xff86b7,0x7ad6ff,0xffc07a,0xd8b3ff,0xa8ffcf]; const deco=[];
  for(let i=0;i<50;i++){ deco.push(addCandy(-3.2,-44*i-30, cols[i%cols.length])); deco.push(addCandy(3.2,-44*i-50, cols[(i+1)%cols.length])); }

  // Oreo
  function createOreo(){ const g1=new THREE.CylinderGeometry(.52,.52,.2,64);
    const g2=new THREE.CylinderGeometry(.49,.49,.09,48);
    const matB=new THREE.MeshStandardMaterial({ color:0x3b2f2f, metalness:.35, roughness:.55 });
    const matC=new THREE.MeshStandardMaterial({ color:0xffffff, metalness:.05, roughness:.35, emissive:0x222222, emissiveIntensity:.05 });
    const top=new THREE.Mesh(g1,matB), bot=new THREE.Mesh(g1,matB), cream=new THREE.Mesh(g2,matC);
    top.position.y=.14; bot.position.y=-.14;
    const group=new THREE.Group(); group.add(top,bot,cream);
    const eye=new THREE.SphereGeometry(.038,16,12), eyeM=new THREE.MeshStandardMaterial({color:0x111111});
    const e1=new THREE.Mesh(eye,eyeM), e2=new THREE.Mesh(eye,eyeM); e1.position.set(-.12,.06,.49); e2.position.set(.12,.06,.49); group.add(e1,e2);
    return group;
  }
  const player=createOreo(); player.position.set(0,.78,0); scene.add(player);
  const haloTex=(()=>{ const c=document.createElement('canvas'); c.width=256; c.height=256; const g=c.getContext('2d'); const grd=g.createRadialGradient(128,128,40,128,128,128); grd.addColorStop(0,'rgba(85,221,255,.35)'); grd.addColorStop(1,'rgba(85,221,255,0)'); g.fillStyle=grd; g.fillRect(0,0,256,256); return new THREE.CanvasTexture(c); })();
  const halo=new THREE.Sprite(new THREE.SpriteMaterial({ map:haloTex, color:0x55ddff, transparent:true, opacity:0 })); halo.scale.set(2.6,2.6,1); player.add(halo); halo.position.set(0,0,.1);

  // Particles
  const spriteTex = (()=>{ const c=document.createElement('canvas'); c.width=c.height=32; const g=c.getContext('2d');
    g.fillStyle='rgba(255,255,255,0)'; g.fillRect(0,0,32,32); const grad=g.createRadialGradient(16,16,2,16,16,16);
    grad.addColorStop(0,'rgba(255,255,255,1)'); grad.addColorStop(1,'rgba(255,255,255,0)'); g.fillStyle=grad; g.beginPath(); g.arc(16,16,16,0,Math.PI*2); g.fill();
    return new THREE.CanvasTexture(c);
  })();
  function burst(x,y,z,color=0xffffff){ for(let i=0;i<12;i++){ const s=new THREE.Sprite(new THREE.SpriteMaterial({ map:spriteTex, color }));
      s.scale.set(.35,.35,1); s.position.set(x,y,z); s.userData={vx:(Math.random()-.5)*1.6, vy:Math.random()*1.6, vz:(Math.random()-.5)*1.6, life:.55};
      scene.add(s); particles.push(s);} }
  const particles=[];

  // Lanes & camera
  const laneX=[-1.8,0,1.8]; let laneIdx=1, targetX=0;
  let camYaw=0, camPitch=-0.06;

  // State
  const DIFF={ easy:{speed:.22,spawn:1.0,bonus:.9}, mid:{speed:.28,spawn:.85,bonus:1.0}, hard:{speed:.36,spawn:.7,bonus:1.15} };
  let diff=DIFF.mid, speed=diff.speed, timeLeft=30, score=0, best=+localStorage.getItem('mdz_best_v12')||0;
  let running=false, paused=false;
  let boostTimer=0, shieldTimer=0, magnetTimer=0;
  let timeScale=1.0; // hitstop
  let combo=0, comboT=0;

  // HUD
  const hud={ level:qs('#levelLabel'), score:qs('#scoreLabel'), best:qs('#bestLabel'), status:qs('#statusLabel'),
              toast:qs('#toast'), count:qs('#count'), mask:qs('#mask'), banner:qs('#banner'), hint:qs('#hint'), plus:qs('#plus'),
              comboFill:qs('#combofill'), comboX:qs('#comboX') };
  function toast(s){ hud.toast.textContent=s; hud.toast.classList.add('show'); clearTimeout(toast.t); toast.t=setTimeout(()=>hud.toast.classList.remove('show'),1800); }
  function showPlus(screenX, screenY, txt='+1'){
    const el=hud.plus; el.textContent=txt; el.style.left=(screenX-10)+'px'; el.style.top=(screenY-10)+'px';
    el.style.opacity='0'; el.style.transition='none'; el.offsetHeight;
    el.style.transition='transform .5s ease, opacity .5s ease'; el.style.transform='translateY(-24px)'; el.style.opacity='1';
    clearTimeout(showPlus.t); showPlus.t=setTimeout(()=>{ el.style.opacity='0'; }, 420);
  }
  function flashScreen(){ flash.style.opacity='0.55'; setTimeout(()=>flash.style.opacity='0', 60); }

  // Physics
  let vy=0, jumps=0, onGround=true, coyote=0, buffer=0; const G=.0175, COYOTE=.18, BUFFER=.18;
  function requestJump(){ buffer=BUFFER; performJump(); }
  function performJump(){ if(sliding) return; if(onGround||coyote>0){ vy=.42; onGround=false; jumps=1; coyote=0; buffer=0; pulse(1.07); beep(1100, .08, .15);} else if(jumps===1){ vy=.36; jumps=2; buffer=0; pulse(1.1); beep(980, .07, .12);} }
  let sliding=false, slideT=0; function startSlide(){ if(sliding) return; sliding=true; slideT=.72; player.scale.y=.6; player.scale.x=1.16; }
  function endSlide(){ sliding=false; player.scale.set(1,1,1); }
  function pulse(s=1.05){ player.scale.set(s,1/s,s); setTimeout(()=>player.scale.set(1,1,1),120); }

  // Entities
  const obstacles=[], crumbs=[], shots=[], goodies=[];
  function spawnCrumbs(){ const lane=Math.floor(Math.random()*3), x=laneX[lane]; const n=6+Math.floor(Math.random()*4);
    for(let i=0;i<n;i++){ const s=new THREE.Mesh(new THREE.SphereGeometry(.06,12,10), new THREE.MeshStandardMaterial({ color:0x6d3b2a })); s.position.set(x,.78+Math.sin(i/n*Math.PI)*.5,-66-i*.9); scene.add(s); crumbs.push(s);} }
  function mkBarrier(){ const grp=new THREE.Group();
    const b=new THREE.Mesh(new THREE.BoxGeometry(1.2,.48,.3), new THREE.MeshStandardMaterial({ color:0x3a3a4a })); b.position.y=.31;
    const lab=makeBillboard('ERP —É–ø–∞–ª','#ffb84b'); lab.position.set(0,1.05,0); grp.add(b,lab); grp.userData.kind='barrier'; grp.position.set(laneX[Math.floor(Math.random()*3)],0,-70); return grp; }
  function mkGate(){ const g=new THREE.Group(); const h=new THREE.Mesh(new THREE.BoxGeometry(1.18,.24,.5), new THREE.MeshStandardMaterial({ color:0x7ad6ff, emissive:0x7ad6ff, emissiveIntensity:.25 }));
    h.position.y=.95; const leg1=new THREE.Mesh(new THREE.BoxGeometry(.08,.9,.5), new THREE.MeshStandardMaterial({ color:0x3b6cff }));
    const leg2=leg1.clone(); leg1.position.set(-.55,.45,0); leg2.position.set(.55,.45,0);
    const lab=makeBillboard('–ù–∏–∑–∫–∏–π –±–∞—Ä—å–µ—Ä','#7ad6ff'); lab.position.set(0,1.35,0); g.add(h,leg1,leg2,lab); g.position.set(laneX[Math.floor(Math.random()*3)],0,-70); g.userData.kind='gate'; return g; }
  function spawnObstacle(){ const r=Math.random(); const o = r<.7 ? mkBarrier() : mkGate(); scene.add(o); obstacles.push(o); }
  function spawnGoodie(){
    const lane=Math.floor(Math.random()*3), x=laneX[lane]; const r=Math.random(); let type='boost', col=0x7ad6ff, label='BOOST';
    if(r<.33){ type='shield'; col=0x88e6ff; label='–©–ò–¢'; }
    else if(r<.66){ type='magnet'; col=0xffa86b; label='–ú–ê–ì–ù–ò–¢'; }
    const t=new THREE.Mesh(new THREE.TorusGeometry(.28,.08,16,24), new THREE.MeshStandardMaterial({ color:col, emissive:col, emissiveIntensity:1.2 }));
    const bb=makeBillboard(label, '#'+col.toString(16).padStart(6,'0'));
    t.position.set(x, 1.0+Math.random()*.6, -68); bb.position.set(x, 2.0, -68);
    t.castShadow=true; t.userData.type=type; scene.add(t,bb); t.userData.bb=bb; goodies.push(t);
  }
  function makeBillboard(text, color){
    const can=document.createElement('canvas'); can.width=256; can.height=128; const c=can.getContext('2d');
    c.fillStyle='rgba(255,255,255,.95)'; c.strokeStyle=color; c.lineWidth=6;
    round(c,12,12,232,48,14); c.fill(); c.stroke();
    c.fillStyle=color; c.font='bold 32px ui-sans-serif,system-ui'; c.textAlign='center'; c.textBaseline='middle'; c.fillText(text, 128, 36);
    const tex=new THREE.CanvasTexture(can); const spr=new THREE.Sprite(new THREE.SpriteMaterial({ map:tex, transparent:true })); spr.scale.set(2.0,1.0,1); spr.userData.dispose=()=>tex.dispose(); return spr;
  }
  function round(c,x,y,w,h,r){ c.beginPath(); c.moveTo(x+r,y); c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r); c.arcTo(x,y+h,x,y,r); c.arcTo(x,y,x+w,y,r); c.closePath(); }

  // Shots
  function shoot(){ const p=new THREE.Mesh(new THREE.SphereGeometry(.08,10,10), new THREE.MeshStandardMaterial({color:0x6d3b2a, emissive:0x221100, emissiveIntensity:.2})); p.position.copy(player.position); p.position.y+=.1; p.userData={vz:-1.25}; shots.push(p); scene.add(p); beep(760,.05,.12); }
  let shooting=false; function setShooting(v){ shooting=v; if(v) ensureAudio(); }

  // Loop
  let last=performance.now(); function loop(){ const now=performance.now(), rawdt=Math.min(.05,(now-last)/1000); last=now;
    const dt=rawdt*clamp(timeScale,0.05,1.0);
    if(running&&!paused){ update(dt); } renderer.render(scene,camera); requestAnimationFrame(loop);} loop();

  function update(dt){
    timeLeft-=dt; if(timeLeft<=0){ timeLeft=30; }

    // Camera follow & tilt
    const camTx = lerp(camera.position.x, player.position.x*0.18, dt*3.5);
    camera.position.x = camTx;
    camera.position.z = lerp(camera.position.z, 7.0 + Math.abs(player.position.x)*0.15, dt*2.0);
    camera.position.y = lerp(camera.position.y, 2.0 + (sliding? -0.12 : 0), dt*3.0);
    camYaw = lerp(camYaw, (player.position.x/1.8)*0.12, dt*3.5);
    camera.rotation.set(-0.06, camYaw, 0);

    // Motion
    const m = speed*200*(boostTimer>0?1.6:1.0);
    ground.position.z += m*dt; if(ground.position.z>-360) ground.position.z=-560; gtex.offset.y -= dt*(speed*(boostTimer>0?1.6:1.0));
    deco.forEach(d=>{ d.position.z += m*dt; if(d.position.z>12) d.position.z -= 88*12; });

    // Spawns
    if(Math.random()<dt*1.12) spawnCrumbs();
    if(Math.random()<dt*.82) spawnObstacle();
    if(Math.random()<dt*.32) spawnGoodie();

    // Shots
    if(shooting && Math.random()<dt*12) shoot();
    for(let i=shots.length-1;i>=0;i--){ const s=shots[i]; s.position.z += s.userData.vz*8; if(s.position.z<-200){ scene.remove(s); shots.splice(i,1); continue; }
      for(let j=obstacles.length-1;j>=0;j--){ const o=obstacles[j]; if(Math.abs(o.position.z-s.position.z)<.6 && Math.abs(o.position.x-s.position.x)<.7){
          burst(o.position.x,.9,o.position.z,0xffcc88); scene.remove(o); if(o.userData && o.userData.kind && o.children) o.children.forEach(ch=>{ if(ch.userData&&ch.userData.dispose) ch.userData.dispose(); scene.remove(ch); });
          obstacles.splice(j,1); scene.remove(s); shots.splice(i,1);
          addCombo(1); addScore(2, o.position); flashScreen(); break; } } }

    // Goodies
    for(let i=goodies.length-1;i>=0;i--){ const g=goodies[i]; g.position.z += m*dt; if(g.userData.bb) g.userData.bb.position.z += m*dt;
      if(g.position.z>6){ if(g.userData.bb){ scene.remove(g.userData.bb);} scene.remove(g); goodies.splice(i,1); continue; }
      if(g.position.distanceTo(player.position)<.9){
        if(g.userData.type==='shield'){ shieldTimer=4.0; toast('–©–∏—Ç –∞–∫—Ç–∏–≤–µ–Ω'); }
        else if(g.userData.type==='magnet'){ magnetTimer=4.0; toast('–ú–∞–≥–Ω–∏—Ç!'); }
        else { boostTimer=2.8; toast('–£—Å–∫–æ—Ä–µ–Ω–∏–µ'); }
        burst(g.position.x,g.position.y,g.position.z,0x7ad6ff); if(g.userData.bb){ scene.remove(g.userData.bb);} scene.remove(g); goodies.splice(i,1);
      } }

    // Magnet pull
    if(magnetTimer>0){ for(const c of crumbs){ const d=c.position.distanceTo(player.position); if(d<4){ const dir=player.position.clone().sub(c.position).normalize(); c.position.addScaledVector(dir, dt* (3.5 - d) * 4); } } }

    // Crumbs
    for(let i=crumbs.length-1;i>=0;i--){ const c=crumbs[i]; c.position.z += m*dt; if(c.position.z>6){ scene.remove(c); crumbs.splice(i,1); continue; }
      if(c.position.distanceTo(player.position)<.7){
        addCombo(.2); addScore(1, c.position); crunch();
        scene.remove(c); crumbs.splice(i,1);
      } }

    // Obstacles ‚Äî capsule-like collision (x,y inside) + height check
    for(let i=obstacles.length-1;i>=0;i--){ const o=obstacles[i]; o.position.z += m*dt; if(o.position.z>6){ disposeObs(o); obstacles.splice(i,1); continue; }
      const nearZ=Math.abs(o.position.z-player.position.z)<.55, nearX=Math.abs(o.position.x-player.position.x)<.75;
      const verticalOK = (o.userData.kind==='gate') ? !sliding : Math.abs((o.position.y+0.3)-player.position.y)<.6;
      if(nearZ && nearX && verticalOK){
        if(shieldTimer>0){ shieldTimer=0; burst(o.position.x,.9,o.position.z,0x88e6ff); disposeObs(o); obstacles.splice(i,1); toast('–©–∏—Ç —Å–ø–∞—Å!'); }
        else { return gameOver(); }
      } }
    function disposeObs(o){ scene.remove(o); if(o.children) o.children.forEach(ch=>{ if(ch.userData&&ch.userData.dispose) ch.userData.dispose(); scene.remove(ch); }); }

    // Player lanes
    player.position.x = lerp(player.position.x, targetX, dt*10);

    // Jump/slide
    vy -= G*(1+(jumps===2?.2:0)); player.position.y += vy;
    if(player.position.y<=.78){ player.position.y=.78; if(!onGround){ onGround=true; jumps=0; } }
    else { if(onGround){ onGround=false; coyote=COYOTE; } }
    if(coyote>0) coyote-=dt; if(buffer>0){ buffer-=dt; if(onGround) performJump(); }
    if(sliding){ slideT-=dt; if(slideT<=0) endSlide(); }

    // Timers & FX
    if(shieldTimer>0){ halo.material.opacity=Math.min(.95,.5+Math.sin(performance.now()/100)*.35); } else { halo.material.opacity=Math.max(0,halo.material.opacity- dt*2); }
    if(boostTimer>0){ boostTimer-=dt; view.style.filter='blur(1px) saturate(1.12)'; camera.fov=62; camera.updateProjectionMatrix(); } else { view.style.filter='none'; camera.fov=60; camera.updateProjectionMatrix(); }
    if(magnetTimer>0){ magnetTimer-=dt; }
    if(comboT>0){ comboT-=dt; } else { combo=Math.max(0, combo-0.02); }
    hud.comboFill.style.width = clamp(combo*120, 0, 120)+'px'; hud.comboX.textContent = 'x'+(1+Math.floor(combo/2));

    // HUD
    hud.score.textContent='–û—á–∫–∏ (–∫—Ä–æ—à–∫–∏): '+score; hud.best.textContent='–†–µ–∫–æ—Ä–¥: '+Math.max(best,score);
    hud.status.textContent = (shieldTimer>0?'–©–∏—Ç ‚Ä¢ ':'') + (boostTimer>0?'–ë—É—Å—Ç ‚Ä¢ ':'') + (magnetTimer>0?'–ú–∞–≥–Ω–∏—Ç ‚Ä¢ ':'') + `–°–∫–æ—Ä–æ—Å—Ç—å: ${(speed*(boostTimer>0?1.6:1.0)).toFixed(2)}`;

    // Decay timescale
    timeScale = lerp(timeScale, 1.0, dt*6);
  }

  function addScore(v, worldPos){
    let mult = 1+Math.floor(combo/2);
    score += v*mult;
    const v2=worldPos.clone().project(camera); const sx=(v2.x*0.5+0.5)*innerWidth, sy=(-v2.y*0.5+0.5)*innerHeight; showPlus(sx, sy, (mult>1?`+${v}x${mult}`:`+${v}`));
  }
  function addCombo(amount){ combo = clamp(combo+amount, 0, 5); comboT = 2.0; timeScale = 0.7; flashScreen(); }

  function clearAll(){ for(const a of [obstacles,crumbs,goodies,shots,particles]){ a.forEach(m=>scene.remove(m)); a.length=0; } }
  function start(level){
    diff=DIFF[level]||DIFF.mid; speed=diff.speed;
    hud.mask.style.display='none'; hud.banner.style.display='none'; document.getElementById('controls').classList.add('enabled');
    clearAll(); timeLeft=30; score=0; boostTimer=0; shieldTimer=0; magnetTimer=0; combo=0; comboT=0; timeScale=1.0;
    player.position.set(0,.78,0); targetX=0; laneIdx=1; vy=0; jumps=0; onGround=true; coyote=0; sliding=false;
    paused=false; running=false;
    let n=3; hud.count.textContent=n; hud.count.classList.remove('hidden');
    const tick=()=>{ n--; if(n>0){ hud.count.textContent=n; setTimeout(tick,600);} else { hud.count.classList.add('hidden'); running=true; } }; setTimeout(tick,600);
  }
  function gameOver(){ running=false; best=Math.max(best,score); localStorage.setItem('mdz_best_v12',best); toast('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞');
    timeScale=0.35; flashScreen(); setTimeout(()=>start('mid'),1100); }

  // ---------- INPUT ----------
  function handleAction(act){
    switch(act){
      case 'start-easy': return setTimeout(()=>start('easy'),20);
      case 'start-mid':  return setTimeout(()=>start('mid'),20);
      case 'start-hard': return setTimeout(()=>start('hard'),20);
      case 'pause':      paused=!paused; toast(paused?'–ü–∞—É–∑–∞':'–ü–æ–µ—Ö–∞–ª–∏!'); return;
      case 'restart':    return start('mid');
      case 'mute':       muted=!muted; qs('[data-action=mute]').textContent = '–ó–≤—É–∫: ' + (muted?'–í—ã–∫–ª':'–í–∫–ª'); return;
      case 'lane-left':  laneIdx=Math.max(0,laneIdx-1); targetX=laneX[laneIdx]; return;
      case 'lane-right': laneIdx=Math.min(2,laneIdx+1); targetX=laneX[laneIdx]; return;
      case 'jump':       return requestJump();
      case 'slide':      return startSlide();
      case 'shoot':      return shoot();
    }
  }
  function delegateTap(e){
    let el=e.target; if(el.nodeType===3) el=el.parentNode;
    const btn=el.closest('[data-action]'); if(!btn) return;
    e.preventDefault(); e.stopPropagation(); handleAction(btn.getAttribute('data-action'));
  }
  ['pointerdown','pointerup','click','touchend'].forEach(ev=>document.addEventListener(ev, delegateTap, true));

  // Zones gestures
  let L_active=false, Lx=0;
  document.querySelector('[data-zone=left]').addEventListener('touchstart', e=>{ if(e.touches.length===1){ L_active=true; Lx=e.touches[0].clientX; } }, {passive:true});
  document.querySelector('[data-zone=left]').addEventListener('touchmove', e=>{ if(!L_active) return; const dx=e.touches[0].clientX-Lx; if(Math.abs(dx)>48){ if(dx>0){ handleAction('lane-right'); } else { handleAction('lane-left'); } L_active=false; } }, {passive:true});
  document.querySelector('[data-zone=left]').addEventListener('touchend', ()=>{ L_active=false; }, {passive:true});

  let R_active=false, Rx=0,Ry=0; 
  const rightZone=document.querySelector('[data-zone=right]');
  rightZone.addEventListener('touchstart', e=>{ if(e.touches.length===1){ R_active=true; Rx=e.touches[0].clientX; Ry=e.touches[0].clientY; ensureAudio(); } }, {passive:true});
  rightZone.addEventListener('touchmove', e=>{
    if(!R_active) return; const dx=e.touches[0].clientX-Rx; const dy=e.touches[0].clientY-Ry;
    if(Math.abs(dy)>60 && Math.abs(dy)>Math.abs(dx)){ if(dy>0){ handleAction('slide'); } else { handleAction('jump'); } R_active=false; }
  }, {passive:true});
  rightZone.addEventListener('touchend', ()=>{ R_active=false; }, {passive:true});

  // Auto fire by hold on shoot button
  const shootBtn = document.querySelector('[data-action=shoot]'); let fireLoop=null;
  function startFire(){ if(fireLoop) return; fireLoop=setInterval(shoot, 150); }
  function stopFire(){ if(fireLoop){ clearInterval(fireLoop); fireLoop=null; } }
  ['pointerdown','touchstart','mousedown'].forEach(ev=>shootBtn.addEventListener(ev, e=>{ e.preventDefault(); ensureAudio(); startFire(); }, {passive:false}));
  ['pointerup','pointercancel','touchend','mouseup','mouseleave'].forEach(ev=>shootBtn.addEventListener(ev, e=>{ e.preventDefault(); stopFire(); }, {passive:false}));

  // Resize
  window.addEventListener('resize', ()=>{ renderer.setSize(innerWidth, innerHeight); camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); });

})();</script>
</body>
</html>
